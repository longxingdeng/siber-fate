<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>赛博知命 - 量子命理演算系统</title>
    <style>
        :root {
            --cyber-gradient: linear-gradient(135deg, #00F3FF 0%, #2A0F37 50%, #FF00FF 100%);
            --cyber-purple: #2A0F37;
            --neon-pink: #FF00FF;
            --star-trail: #00F3FF;
            --matrix-green: #00FF00;
        }

        body {
            background: var(--cyber-purple);
            color: var(--star-trail);
            font-family: 'Orbitron', 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            scroll-behavior: smooth;
            margin: 20px;
            padding: 0;
        }

        /* 新增处理状态样式 */
        .processing-box {
            border: 2px solid var(--star-trail);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            display: none;
        }
        .processing-steps {
            color: var(--matrix-green);
            font-size: 0.9em;
            margin: 1rem 0;
        }
        #processing-message {
            color: var(--star-trail);
            text-align: center;
            font-size: 1.1em;
        }


        /* 量子场域分隔符 */
        .nebula-divider {
            position: relative;
            margin: 2rem 0;
            border-top: 1px solid var(--neon-pink);
        }
        .nebula-divider::before {
            content: attr(data-text);
            position: absolute;
            top: -0.8em;
            left: 50%;
            transform: translateX(-50%);
            padding: 0 1rem;
            background: var(--cyber-purple);
            font-size: 0.9em;
            text-shadow: 0 0 10px var(--matrix-green);
        }

        .cyber-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border: 2px solid var(--star-trail);
            box-shadow: 0 0 30px var(--neon-pink);
            background: rgba(0, 0, 0, 0.8); /* 恢复黑色背景 */
            border-radius: 8px; /* 保留圆角 */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* 保留阴影 */
        }

        .cyber-title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            position: relative;
            margin: 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(45deg,
                rgba(0, 243, 255, 0.1) 0%,
                rgba(42, 15, 55, 0.3) 50%,
                rgba(255, 0, 255, 0.1) 100%);
            border: 2px solid var(--star-trail);
            box-shadow: 0 0 30px var(--neon-pink);
            color: #333;
        }

        .neon-subtitle {
            color: var(--star-trail);
            text-shadow: 0 0 5px var(--matrix-green);
            text-align: center;
            font-size: 1.2em;
            margin-top: -1rem;
        }

        .glitch-text {
            display: block;
            font-size: 3.5rem;
            color: var(--star-trail);
            text-shadow:
                2px 0 var(--neon-pink),
                -2px 0 var(--matrix-green),
                0 0 20px rgba(255,0,255,0.5);
            animation: glitch 2s infinite;
        }

        /* 赛博玄学输入域 */
        .cyber-field {
            margin: 1.5rem 0;
            position: relative;
        }

        .neon-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1.1em;
            color: var(--star-trail); /*  改回原来的蓝色  */
            text-shadow: 0 0 2px var(--matrix-green); /*  将模糊半径从 5px 减小到 2px  */
            font-weight: bold;
            /* color: #555;  这行可以删除 */
        }

        .hologram-text::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--cyber-gradient);
            opacity: 0.7;
        }
        .optional-tag {
            font-size: 0.8em;
            color: var(--star-trail);
            margin-left: 0.5em;
        }

        /* 极性振荡选择器 */
        .gender-selector {
            display: flex;
            gap: 2rem;
            margin: 1.5rem 0;
        }
        .quantum-polarity {
            position: relative;
            flex: 1;
            transition: transform 0.3s;
        }
        .quantum-polarity:hover {
            transform: translateY(-3px);
        }
        .polarity-label {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--star-trail);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quantum-radio:checked + .polarity-label {
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 15px var(--star-trail);
        }
        .sigil {
            font-size: 1.5em;
            margin-right: 0.8rem;
        }

        /* 时间扰动特效 */
        .temporal-input {
            position: relative;
            display: flex; /* Make temporal input container a flex container */
            align-items: center; /* Align items vertically in the center */
        }
        .temporal-input select, .temporal-input input[type="date"] {
            margin-right: 5px; /* Add some spacing between date/time selectors */
            width: auto; /* Adjust width as needed */
            flex: 1; /* Allow selectors to take available space */
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--star-trail);
            color: var(--star-trail);
            border-radius: 5px;
            appearance: none; /* Remove default dropdown arrow in some browsers */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            -moz-appearance: none; /* For Firefox */
            font-size: 16px;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 8px);
            background-position-y: center;
        }
        .timeshock-indicator {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--matrix-green);
            box-shadow: 0 0 10px var(--matrix-green);
            animation: temporal-pulse 1.5s infinite;
        }

        .cyber-input {
            width: 100%;
            padding: 0.7rem;
            margin: 0.3rem 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--star-trail);
            color: var(--star-trail);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* Checkbox styles */
        .cyber-checkbox-field {
            margin: 1rem 0;
            display: flex;
            align-items: center;
        }
        .cyber-checkbox {
            appearance: none; /* Remove default checkbox appearance */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            width: 20px;
            height: 20px;
            border: 2px solid var(--star-trail);
            background-color: transparent;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }
        .cyber-checkbox:checked {
            background-color: var(--star-trail);
            border-color: var(--star-trail);
        }
        .cyber-checkbox:checked::after {
            content: '\2714'; /* Checkmark character */
            font-size: 16px;
            color: var(--cyber-purple);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .cyber-checkbox-label {
            margin-left: 0.5rem;
            color: var(--star-trail);
            font-size: 0.9em;
        }

        /* Submit button */
         .cyber-submit-button {
            padding: 1rem 2rem;
            background:linear-gradient(135deg, #000080 0%, #00FFFF 100%); /* 深蓝到亮青 */
            color: white; /* 修改文字颜色为白色 */
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s;
            display: block;
            margin: 2rem auto;
            box-shadow: 0 0 15px var(--neon-pink);
        }

        .cyber-submit-button:hover {
            transform: scale(1.05);
        }

        #generate-btn {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            margin-top: 1rem;
            background:linear-gradient(135deg, #000080 0%, #00FFFF 100%);
            box-shadow: 0 0 15px var(--neon-pink);
        }

        #generate-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        #error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }

        #api-error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }

        pre {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            position: relative;
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--star-trail);
            border: 1px solid var(--star-trail);
            box-shadow: 0 0 15px var(--neon-pink);
            margin-top: 1rem;
        }

        .form-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--neon-pink);
            margin-bottom: 1.5rem;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background:linear-gradient(135deg, #000080 0%, #00FFFF 100%);
            box-shadow: 0 0 10px var(--neon-pink);
        }

        .copy-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        #llm-output {
            white-space: pre-wrap; /* 保留换行和空格 */
        }

        #processing-message {
            color: var(--star-trail);
            text-align: center;
            margin-top: 1rem;
            display: none; /* Initially hidden */
        }

        @keyframes glitch {
            0% { transform: translate(2px, 0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(0, -1px); }
            60% { transform: translate(1px, 1px); }
            80% { transform: translate(-1px, -1px); }
            100% { transform: translate(0, 0); }
        }
        @keyframes temporal-pulse {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(1); }
        }

        /* 保留原有量子背景和滚动条样式 */
        .quantum-bg { position: fixed; z-index: -1; }
        ::-webkit-scrollbar { width: 10px; background: rgba(0, 243, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: var(--cyber-gradient); }

        /* Dropdown arrow styling for consistency across browsers */
        select.cyber-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 8px);
            background-position-y: center;
        }

        .date-group {
            display: flex;
            gap: 10px;
        }

        .date-group input {
            width: 33%;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        input[type="radio"] {
            margin: 0;
        }

    </style>
</head>
<body>
    <canvas class="quantum-bg"></canvas>

    <div class="cyber-container">
        <h1 class="cyber-title">
            <span class="glitch-text">𓊖 赛博知命</span>
            <div class="neon-subtitle">量子命理演算系统 v2.0</div>
        </h1>

        <div class="quantum-form">
            <div class="nebula-divider" data-text="𓎜 量子纠缠锚点"></div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">姓氏(建議使用繁體字)</span>
                    <span class="optional-tag">（选填）</span>
                </label>
                <input type="text" class="cyber-input"
                     placeholder="请输入姓氏">
            </div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">名字(建議使用繁體字)</span>
                    <span class="optional-tag">（选填）</span>
                </label>
                <input type="text" class="cyber-input"
                     placeholder="请输入名字">
            </div>

            <div class="cyber-field">
                <label class="neon-label">性别:</label>
                <div class="gender-selector">
                    <div class="quantum-polarity" data-polarity="♂">
                        <input type="radio" name="gender" id="male"
                             class="quantum-radio" value="乾造" hidden>
                        <label for="male" class="polarity-label">
                            <span class="sigil">𓁛</span>
                            <span class="polarity-text">男</span >
                        </label>
                    </div>
                    <div class="quantum-polarity" data-polarity="♀">
                        <input type="radio" name="gender" id="female"
                             class="quantum-radio" value="坤造" hidden>
                        <label for="female" class="polarity-label">
                            <span class="sigil">𓁟</span>
                            <span class="polarity-text">女</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">阳历出生年月日时分 | 请用+8时区:</span>
                </label>
                <div class="temporal-input">
                    <input type="date" class="cyber-input" id="birthDate">
                    <select class="cyber-input" id="birthHour">
                        <option value="">-- 时 --</option>
                        <option value="00">00</option> <option value="01">01</option> <option value="02">02</option> <option value="03">03</option> <option value="04">04</option> <option value="05">05</option> <option value="06">06</option> <option value="07">07</option> <option value="08">08</option> <option value="09">09</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option>
                    </select>
                    <select class="cyber-input" id="birthMinute">
                        <option value="">-- 分 --</option>
                        <option value="00">00</option> <option value="01">01</option> <option value="02">02</option> <option value="03">03</option> <option value="04">04</option> <option value="05">05</option> <option value="06">06</option> <option value="07">07</option> <option value="08">08</option> <option value="09">09</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> <option value="26">26</option> <option value="27">27</option> <option value="28">28</option> <option value="29">29</option> <option value="30">30</option> <option value="31">31</option> <option value="32">32</option> <option value="33">33</option> <option value="34">34</option> <option value="35">35</option> <option value="36">36</option> <option value="37">37</option> <option value="38">38</option> <option value="39">39</option> <option value="40">40</option> <option value="41">41</option> <option value="42">42</option> <option value="43">43</option> <option value="44">44</option> <option value="45">45</option> <option value="46">46</option> <option value="47">47</option> <option value="48">48</option> <option value="49">49</option> <option value="50">50</option> <option value="51">51</option> <option value="52">52</option> <option value="53">53</option> <option value="54">54</option> <option value="55">55</option> <option value="56">56</option> <option value="57">57</option> <option value="58">58</option> <option value="59">59</option>
                    </select>
                    <div class="timeshock-indicator"></div>
                </div>
            </div>

            <div class="cyber-field">
                <label class="neon-label">出生省份/直辖市:</label>
                <select class="cyber-input" id="birthProvince">
                    <option value="">- 请选择省份 -</option>

                    <!-- Add more countries as needed -->
                </select>
            </div>

            <div class="cyber-field">
                <label class="neon-label">出生城市:</label>
                <select class="cyber-input" id="birthCity">
                    <option value="">- 请选择城市 -</option>
                    <!-- Add more cities as needed, potentially based on country selection -->
                </select>
            </div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">自定义经度 (选填)</span>
                </label>
                <input type="text" class="cyber-input" placeholder="例如: 121.5">
                <p style="font-size: 0.8em; margin-top: 0.3rem;">若填写此栏位将优先使用自定义经度 (有效范围: -180 到 180，东经为正值)</p>
            </div>

            <div class="cyber-field">
                <label class="neon-label">模型选择 (Model):</label>
                <select class="cyber-input" id="llmModel">
                    <option value="deepseek-r1">deepseek-r1 (高性能模型)</option>
                    <option value="deepseek-v3">deepseek-v3 (经济型模型)</option>
                    <!-- Add more model options as needed -->
                </select>
            </div>

            <div class="cyber-checkbox-field">
                <input type="checkbox" class="cyber-checkbox" id="useSolarTime" checked>
                <label for="useSolarTime" class="cyber-checkbox-label">使用真太阳时:</label>
            </div>

            <div class="cyber-checkbox-field">
                <input type="checkbox" class="cyber-checkbox" id="addZiWeiDouShu" checked>
                <label for="addZiWeiDouShu" class="cyber-checkbox-label">加入紫微斗数:</label>
            </div>

            <div class="nebula-divider" data-text="🔑 API 密钥 (LLM)"></div>
            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">API 密钥</span>
                </label>
                <input type="password" class="cyber-input" id="llmApiKey" placeholder="请输入您的 API 密钥">
            </div>
            
            <!-- 新增处理状态显示 -->
            <div class="processing-box" id="processing-box">
                <div class="neon-label">𓂀 量子演算进度</div>
                <div class="processing-steps" id="processing-steps"></div>
                <div id="processing-message">初始化量子场域...</div>
            </div>

            <button id="generate-btn" class="cyber-submit-button">𓃠 启动量子演算</button>
            <div id="error-message"></div>
            <div id="api-error-message"></div>
            
            <h2 class="neon-label">𓁟 演算结果:</h2>
            <pre id="llm-output"></pre>

            <div class="nebula-divider" data-text="重要声明"></div>
            <div style="color: var(--neon-blue); font-size: 0.9em; text-align: center; margin-bottom: 1rem;">
                命理学是一种复杂的学问仅供参考，不能作为决策的唯一依据。
            </div>
        </div>
    </div>

        <!-- 保留原有星图和结果区域 -->
        <div class="destiny-canvas" id="starMap"></div>
        <div id="quantumResult"></div>
    </div>

    <script>
        // 优化后的量子背景（增加粒子纠缠效果）
        class QuantumBackground {
            constructor() {
                this.canvas = document.querySelector('.quantum-bg');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.init();
                this.animate();
            }

            init() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                // 生成纠缠粒子对
                for(let i = 0; i < 100; i++) {
                    const baseX = Math.random() * this.canvas.width;
                    const baseY = Math.random() * this.canvas.height;
                    this.particles.push(this.createEntangledPair(baseX, baseY));
                }
            }

            createEntangledPair(x, y) {
                return {
                    pair: [
                        { x, y, vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3 },
                        { x, y, vx: -this.vx, vy: -this.vy }
                    ],
                    size: Math.random() * 2,
                    color: Math.random() > 0.5 ? '#00F3FF' : '#FF00FF'
                };
            }

            animate() {
                this.ctx.fillStyle = 'rgba(42, 15, 55, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.particles.forEach(entangledPair => {
                    entangledPair.pair.forEach(particle => {
                        particle.x += particle.vx;
                        particle.y += particle.vy;

                        // 边界反弹
                        if(particle.x < 0 || particle.x > this.canvas.width) particle.vx *= -1;
                        if(particle.y < 0 || particle.y > this.canvas.height) particle.vy *= -1;

                        // 绘制纠缠粒子
                        this.ctx.beginPath();
                        this.ctx.arc(particle.x, particle.y, entangledPair.size, 0, Math.PI*2);
                        this.ctx.fillStyle = entangledPair.color;
                        this.ctx.fill();
                    });

                    // 绘制纠缠光束
                    const [p1, p2] = entangledPair.pair;
                    this.ctx.beginPath();
                    this.ctx.moveTo(p1.x, p1.y);
                    this.ctx.lineTo(p2.x, p2.y);
                    this.ctx.strokeStyle = `${entangledPair.color}30`;
                    this.ctx.lineWidth = 0.3;
                    this.ctx.stroke();
                });

                requestAnimationFrame(() => this.animate());
            }
        }
        new QuantumBackground();

        // 增强极性选择交互
        document.querySelectorAll('.quantum-polarity').forEach(container => {
            container.addEventListener('click', () => {
                const currentActive = document.querySelector('.quantum-radio:checked');
                if (currentActive) currentActive.parentElement.classList.remove('active');
                container.querySelector('.quantum-radio').checked = true;
                container.classList.add('active');
            });
        });

 //Add script tag for lunisolar
 const script = document.createElement('script');
        script.src = "https://unpkg.com/lunisolar@2.5.1/dist/lunisolar.js";
        script.onload = function() {
            const takeSoundScript = document.createElement('script');
            takeSoundScript.src = "https://unpkg.com/@lunisolar/plugin-takesound@0.1.2/dist/index.js";
            document.head.appendChild(takeSoundScript);
        };
        script.onerror = function() {
            console.error("错误：加载 lunisolar 脚本失败");
        };
        document.head.appendChild(script);

        document.addEventListener('DOMContentLoaded', function() {
            const birthDateInput = document.getElementById('birthDate');
            const birthHourInput = document.getElementById('birthHour');
            const birthMinuteInput = document.getElementById('birthMinute');
            const genderRadios = document.getElementsByName('gender');
            const provinceSelect = document.getElementById('birthProvince');
            const citySelect = document.getElementById('birthCity');
            const generateBtn = document.getElementById('generate-btn');
            const startCalculationBtn = document.getElementById('start-calculation-btn'); // New button
            const errorMessage = document.getElementById('error-message');
            const apiErrorMessage = document.getElementById('api-error-message');
            const outputDiv = document.getElementById('output');
            const llmOutputDiv = document.getElementById('llm-output');
            const processingMessageDiv = document.getElementById('processing-message');
            const llmApiKeyInput = document.getElementById('llmApiKey');
            const llmModelSelect = document.getElementById('llmModel'); // 获取模型选择的元素  **添加了这一行**
            const processingBox = document.getElementById('processing-box');
            const stepsDiv = document.getElementById('processing-steps');




            const locationData = {
                "北京市": { "北京市": { longitude: 116.4 } },
                "天津市": { "天津市": { longitude: 117.2 } },
                "河北省": {
                    "石家庄市": { longitude: 114.5 },
                    "唐山市": { longitude: 118.2 },
                    "秦皇岛市": { longitude: 119.6 },
                    "邯郸市": { longitude: 114.5 },
                    "邢台市": { longitude: 114.5 },
                    "保定市": { longitude: 115.5 },
                    "张家口市": { longitude: 114.9 },
                    "承德市": { longitude: 117.9 },
                    "沧州市": { longitude: 116.8 },
                    "廊坊市": { longitude: 116.7 },
                    "衡水市": { longitude: 115.7 }
                },
                "山西省": {
                    "太原市": { longitude: 112.5 },
                    "大同市": { longitude: 113.3 },
                    "阳泉市": { longitude: 113.6 },
                    "长治市": { longitude: 113.1 },
                    "晋城市": { longitude: 112.8 },
                    "朔州市": { longitude: 112.4 },
                    "晋中市": { longitude: 112.7 },
                    "运城市": { longitude: 111.0 },
                    "忻州市": { longitude: 112.7 },
                    "临汾市": { longitude: 111.5 },
                    "吕梁市": { longitude: 111.1 }
                },
                "内蒙古自治区": {
                    "呼和浩特市": { longitude: 111.7 },
                    "包头市": { longitude: 110.0 },
                    "乌海市": { longitude: 118.3 },
                    "赤峰市": { longitude: 118.9 },
                    "通辽市": { longitude: 122.2 },
                    "鄂尔多斯市": { longitude: 109.8 },
                    "呼伦贝尔市": { longitude: 119.7 },
                    "巴彦淖尔市": { longitude: 107.4 },
                    "乌兰察布市": { longitude: 113.2 },
                    "兴安盟": { longitude: 122.1 },
                    "锡林郭勒盟": { longitude: 116.0 },
                    "阿拉善盟": { longitude: 105.7 }
                },
                "辽宁省": {
                    "沈阳市": { longitude: 123.4 },
                    "大连市": { longitude: 121.6 },
                    "鞍山市": { longitude: 122.9 },
                    "抚顺市": { longitude: 123.9 },
                    "本溪市": { longitude: 123.7 },
                    "丹东市": { longitude: 124.3 },
                    "锦州市": { longitude: 121.1 },
                    "营口市": { longitude: 122.2 },
                    "阜新市": { longitude: 121.6 },
                    "辽阳市": { longitude: 123.2 },
                    "盘锦市": { longitude: 122.0 },
                    "铁岭市": { longitude: 123.8 },
                    "朝阳市": { longitude: 120.4 },
                    "葫芦岛市": { longitude: 120.8 }
                },
                "吉林省": {
                    "长春市": { longitude: 125.3 },
                    "吉林市": { longitude: 126.5 },
                    "四平市": { longitude: 124.3 },
                    "辽源市": { longitude: 125.1 },
                    "通化市": { longitude: 125.9 },
                    "白山市": { longitude: 126.4 },
                    "松原市": { longitude: 124.8 },
                    "白城市": { longitude: 122.8 },
                    "延边朝鲜族自治州": { longitude: 129.5 }
                },
                "黑龙江省": {
                    "哈尔滨市": { longitude: 126.6 },
                    "齐齐哈尔市": { longitude: 123.9 },
                    "鸡西市": { longitude: 130.9 },
                    "鹤岗市": { longitude: 130.3 },
                    "双鸭山市": { longitude: 131.1 },
                    "大庆市": { longitude: 125.1 },
                    "伊春市": { longitude: 129.0 },
                    "佳木斯市": { longitude: 130.3 },
                    "七台河市": { longitude: 130.9 },
                    "牡丹江市": { longitude: 129.6 },
                    "黑河市": { longitude: 127.5 },
                    "绥化市": { longitude: 126.9 },
                    "大兴安岭地区": { longitude: 124.7 }
                },
                "上海市": { "上海市": { longitude: 121.4 } },
                "江苏省": {
                    "南京市": { longitude: 118.8 },
                    "无锡市": { longitude: 120.3 },
                    "徐州市": { longitude: 117.2 },
                    "常州市": { longitude: 119.9 },
                    "苏州市": { longitude: 120.6 },
                    "南通市": { longitude: 120.8 },
                    "连云港市": { longitude: 119.2 },
                    "淮安市": { longitude: 119.0 },
                    "盐城市": { longitude: 120.1 },
                    "扬州市": { longitude: 119.4 },
                    "镇江市": { longitude: 119.4 },
                    "泰州市": { longitude: 119.9 },
                    "宿迁市": { longitude: 118.3 }
                },
                "浙江省": {
                    "杭州市": { longitude: 120.2 },
                    "宁波市": { longitude: 121.5 },
                    "温州市": { longitude: 120.6 },
                    "嘉兴市": { longitude: 120.7 },
                    "湖州市": { longitude: 120.1 },
                    "绍兴市": { longitude: 120.5 },
                    "金华市": { longitude: 119.6 },
                    "衢州市": { longitude: 118.8 },
                    "舟山市": { longitude: 122.3 },
                    "台州市": { longitude: 121.4 },
                    "丽水市": { longitude: 119.9 }
                },
                "安徽省": {
                    "合肥市": { longitude: 117.3 },
                    "芜湖市": { longitude: 118.3 },
                    "蚌埠市": { longitude: 117.3 },
                    "淮南市": { longitude: 116.7 },
                    "马鞍山市": { longitude: 118.5 },
                    "淮北市": { longitude: 116.8 },
                    "铜陵市": { longitude: 117.8 },
                    "安庆市": { longitude: 117.0 },
                    "黄山市": { longitude: 118.3 },
                    "滁州市": { longitude: 118.3 },
                    "阜阳市": { longitude: 115.8 },
                    "宿州市": { longitude: 116.9 },
                    "六安市": { longitude: 116.5 },
                    "亳州市": { longitude: 115.7 },
                    "池州市": { longitude: 117.4 },
                    "宣城市": { longitude: 118.7 }
                },
                "福建省": {
                    "福州市": { longitude: 119.3 },
                    "厦门市": { longitude: 118.1 },
                    "莆田市": { longitude: 119.0 },
                    "三明市": { longitude: 117.6 },
                    "泉州市": { longitude: 118.6 },
                    "漳州市": { longitude: 117.6 },
                    "南平市": { longitude: 118.0 },
                    "龙岩市": { longitude: 117.0 },
                    "宁德市": { longitude: 119.5 }
                },
                "江西省": {
                    "南昌市": { longitude: 115.9 },
                    "景德镇市": { longitude: 117.2 },
                    "萍乡市": { longitude: 113.8 },
                    "九江市": { longitude: 116.0 },
                    "新余市": { longitude: 114.9 },
                    "鹰潭市": { longitude: 117.0 },
                    "赣州市": { longitude: 114.9 },
                    "宜春市": { longitude: 114.4 },
                    "上饶市": { longitude: 117.9 },
                    "吉安市": { longitude: 114.9 },
                    "抚州市": { longitude: 116.3 }
                },
                "山东省": {
                    "济南市": { longitude: 117.0 },
                    "青岛市": { longitude: 120.3 },
                    "淄博市": { longitude: 118.0 },
                    "枣庄市": { longitude: 117.5 },
                    "东营市": { longitude: 118.5 },
                    "烟台市": { longitude: 121.4 },
                    "潍坊市": { longitude: 119.1 },
                    "济宁市": { longitude: 116.5 },
                    "泰安市": { longitude: 117.1 },
                    "威海市": { longitude: 122.1 },
                    "日照市": { longitude: 119.5 },
                    "滨州市": { longitude: 118.0 },
                    "德州市": { longitude: 116.3 },
                    "聊城市": { longitude: 115.9 },
                    "临沂市": { longitude: 118.3 },
                    "菏泽市": { longitude: 115.4 }
                },
                "河南省": {
                    "郑州市": { longitude: 113.6 },
                    "开封市": { longitude: 114.3 },
                    "洛阳市": { longitude: 112.4 },
                    "平顶山市": { longitude: 113.3 },
                    "安阳市": { longitude: 114.3 },
                    "鹤壁市": { longitude: 114.3 },
                    "新乡市": { longitude: 113.9 },
                    "焦作市": { longitude: 113.2 },
                    "濮阳市": { longitude: 115.0 },
                    "许昌市": { longitude: 113.8 },
                    "漯河市": { longitude: 114.0 },
                    "三门峡市": { longitude: 111.9 },
                    "南阳市": { longitude: 112.5 },
                    "商丘市": { longitude: 115.6 },
                    "信阳市": { longitude: 114.0 },
                    "周口市": { longitude: 114.6 },
                    "驻马店市": { longitude: 114.0 },
                    "济源市": { longitude: 112.6 }
                },
                "湖北省": {
                    "武汉市": { longitude: 114.3 },
                    "黄石市": { longitude: 114.9 },
                    "十堰市": { longitude: 110.7 },
                    "宜昌市": { longitude: 111.3 },
                    "襄阳市": { longitude: 112.1 },
                    "鄂州市": { longitude: 114.8 },
                    "荆门市": { longitude: 112.2 },
                    "孝感市": { longitude: 113.9 },
                    "荆州市": { longitude: 112.2 },
                    "黄冈市": { longitude: 114.8 },
                    "咸宁市": { longitude: 114.3 },
                    "随州市": { longitude: 113.3 },
                    "恩施土家族苗族自治州": { longitude: 109.4 },
                    "仙桃市": { longitude: 113.4 },
                    "潜江市": { longitude: 112.9 },
                    "天门市": { longitude: 113.1 },
                    "神农架林区": { longitude: 110.3 }
                },
                "湖南省": {
                    "长沙市": { longitude: 113.0 },
                    "株洲市": { longitude: 113.1 },
                    "湘潭市": { longitude: 112.9 },
                    "衡阳市": { longitude: 112.6 },
                    "邵阳市": { longitude: 111.4 },
                    "岳阳市": { longitude: 113.1 },
                    "常德市": { longitude: 111.6 },
                    "张家界市": { longitude: 110.4 },
                    "益阳市": { longitude: 112.3 },
                    "郴州市": { longitude: 113.0 },
                    "永州市": { longitude: 111.6 },
                    "怀化市": { longitude: 110.0 },
                    "娄底市": { longitude: 112.0 },
                    "湘西土家族苗族自治州": { longitude: 109.7 }
                },
                "广东省": {
                    "广州市": { longitude: 113.2 },
                    "韶关市": { longitude: 113.6 },
                    "深圳市": { longitude: 114.0 },
                    "珠海市": { longitude: 113.5 },
                    "汕头市": { longitude: 116.6 },
                    "佛山市": { longitude: 113.1 },
                    "江门市": { longitude: 113.0 },
                    "湛江市": { longitude: 110.3 },
                    "茂名市": { longitude: 110.8 },
                    "肇庆市": { longitude: 112.4 },
                    "惠州市": { longitude: 114.4 },
                    "梅州市": { longitude: 116.1 },
                    "汕尾市": { longitude: 115.3 },
                    "河源市": { longitude: 114.6 },
                    "阳江市": { longitude: 111.9 },
                    "清远市": { longitude: 113.0 },
                    "东莞市": { longitude: 113.7 },
                    "中山市": { longitude: 113.3 },
                    "潮州市": { longitude: 116.6 },
                    "揭阳市": { longitude: 116.3 },
                    "云浮市": { longitude: 112.0 }
                },
                "广西壮族自治区": {
                    "南宁市": { longitude: 108.3 },
                    "柳州市": { longitude: 109.4 },
                    "桂林市": { longitude: 110.2 },
                    "梧州市": { longitude: 111.3 },
                    "北海市": { longitude: 109.1 },
                    "防城港市": { longitude: 108.3 },
                    "钦州市": { longitude: 108.6 },
                    "贵港市": { longitude: 109.5 },
                    "玉林市": { longitude: 110.1 },
                    "百色市": { longitude: 106.6 },
                    "贺州市": { longitude: 111.5 },
                    "河池市": { longitude: 107.9 },
                    "来宾市": { longitude: 109.2 },
                    "崇左市": { longitude: 107.3 }
                },
                "海南省": {
                    "海口市": { longitude: 110.3 },
                    "三亚市": { longitude: 109.5 },
                    "三沙市": { longitude: 112.3 },
                    "儋州市": { longitude: 109.5 },
                    "文昌市": { longitude: 110.7 },
                    "琼海市": { longitude: 110.4 },
                    "万宁市": { longitude: 110.4 },
                    "五指山市": { longitude: 109.5 },
                    "东方市": { longitude: 108.6 },
                    "定安县": { longitude: 110.3 },
                    "屯昌县": { longitude: 109.9 },
                    "澄迈县": { longitude: 110.0 },
                    "临高县": { longitude: 109.7 },
                    "白沙黎族自治县": { longitude: 109.4 },
                    "昌江黎族自治县": { longitude: 109.0 },
                    "乐东黎族自治县": { longitude: 109.1 },
                    "陵水黎族自治县": { longitude: 110.0 },
                    "保亭黎族苗族自治县": { longitude: 109.7 },
                    "琼中黎族苗族自治县": { longitude: 109.8 }
                },
                "重庆市": { "重庆市": { longitude: 106.5 } },
                "四川省": {
                    "成都市": { longitude: 104.0 },
                    "自贡市": { longitude: 104.7 },
                    "攀枝花市": { longitude: 101.7 },
                    "泸州市": { longitude: 105.4 },
                    "德阳市": { longitude: 104.3 },
                    "绵阳市": { longitude: 104.7 },
                    "广元市": { longitude: 105.8 },
                    "遂宁市": { longitude: 105.5 },
                    "内江市": { longitude: 105.0 },
                    "乐山市": { longitude: 103.7 },
                    "南充市": { longitude: 106.1 },
                    "眉山市": { longitude: 103.8 },
                    "宜宾市": { longitude: 104.5 },
                    "广安市": { longitude: 106.6 },
                    "达州市": { longitude: 107.5 },
                    "雅安市": { longitude: 103.0 },
                    "巴中市": { longitude: 106.7 },
                    "资阳市": { longitude: 104.9 },
                    "阿坝藏族羌族自治州": { longitude: 102.2 },
                    "甘孜藏族自治州": { longitude: 101.9 },
                    "凉山彝族自治州": { longitude: 102.2 }
                },
                "贵州省": {
                    "贵阳市": { longitude: 106.7 },
                    "六盘水市": { longitude: 104.8 },
                    "遵义市": { longitude: 106.9 },
                    "安顺市": { longitude: 105.9 },
                    "毕节市": { longitude: 105.2 },
                    "铜仁市": { longitude: 109.1 },
                    "黔东南苗族侗族自治州": { longitude: 107.9 },
                    "黔南布依族苗族自治州": { longitude: 107.5 },
                    "黔西南布依族苗族自治州": { longitude: 104.9 }
                },
                "云南省": {
                    "昆明市": { longitude: 102.7 },
                    "曲靖市": { longitude: 103.8 },
                    "玉溪市": { longitude: 102.5 },
                    "保山市": { longitude: 99.1 },
                    "昭通市": { longitude: 103.7 },
                    "丽江市": { longitude: 100.2 },
                    "普洱市": { longitude: 101.0 },
                    "临沧市": { longitude: 99.9 },
                    "楚雄彝族自治州": { longitude: 101.5 },
                    "红河哈尼族彝族自治州": { longitude: 103.4 },
                    "文山壮族苗族自治州": { longitude: 104.2 },
                    "西双版纳傣族自治州": { longitude: 100.8 },
                    "大理白族自治州": { longitude: 100.2 },
                    "德宏傣族景颇族自治州": { longitude: 98.6 },
                    "怒江傈僳族自治州": { longitude: 98.8 },
                    "迪庆藏族自治州": { longitude: 99.7 }
                },
                "西藏自治区": {
                    "拉萨市": { longitude: 91.1 },
                    "日喀则市": { longitude: 88.8 },
                    "昌都市": { longitude: 97.1 },
                    "林芝市": { longitude: 94.3 },
                    "山南市": { longitude: 91.7 },
                    "那曲市": { longitude: 92.0 },
                    "阿里地区": { longitude: 80.1 }
                },
                "陕西省": {
                    "西安市": { longitude: 108.9 },
                    "铜川市": { longitude: 109.1 },
                    "宝鸡市": { longitude: 107.1 },
                    "咸阳市": { longitude: 108.7 },
                    "渭南市": { longitude: 109.5 },
                    "延安市": { longitude: 109.4 },
                    "汉中市": { longitude: 107.0 },
                    "榆林市": { longitude: 109.7 },
                    "安康市": { longitude: 109.0 },
                    "商洛市": { longitude: 110.0 }
                },
                "甘肃省": {
                    "兰州市": { longitude: 103.7 },
                    "嘉峪关市": { longitude: 98.2 },
                    "金昌市": { longitude: 102.2 },
                    "白银市": { longitude: 104.1 },
                    "天水市": { longitude: 105.7 },
                    "武威市": { longitude: 102.6 },
                    "张掖市": { longitude: 100.4 },
                    "平凉市": { longitude: 106.6 },
                    "酒泉市": { longitude: 98.5 },
                    "庆阳市": { longitude: 107.6 },
                    "定西市": { longitude: 104.6 },
                    "陇南市": { longitude: 104.9 },
                    "临夏回族自治州": { longitude: 103.2 },
                    "甘南藏族自治州": { longitude: 102.9 }
                },
                "青海省": {
                    "西宁市": { longitude: 101.7 },
                    "海东市": { longitude: 102.1 },
                    "海北藏族自治州": { longitude: 100.9 },
                    "黄南藏族自治州": { longitude: 102.0 },
                    "海南藏族自治州": { longitude: 100.6 },
                    "果洛藏族自治州": { longitude: 100.2 },
                    "玉树藏族自治州": { longitude: 97.0 },
                    "海西蒙古族藏族自治州": { longitude: 97.0 }
                },
                "宁夏回族自治区": {
                    "银川市": { longitude: 106.2 },
                    "石嘴山市": { longitude: 106.3 },
                    "吴忠市": { longitude: 106.1 },
                    "固原市": { longitude: 106.2 },
                    "中卫市": { longitude: 105.1 }
                },
                "新疆维吾尔自治区": {
                    "乌鲁木齐市": { longitude: 87.6 },
                    "克拉玛依市": { longitude: 84.7 },
                    "吐鲁番市": { longitude: 89.2 },
                    "哈密市": { longitude: 93.5 },
                    "昌吉回族自治州": { longitude: 87.3 },
                    "博尔塔拉蒙古自治州": { longitude: 82.0 },
                    "巴音郭楞蒙古自治州": { longitude: 86.1 },
                    "阿克苏地区": { longitude: 80.3 },
                    "克孜勒苏柯尔克孜自治州": { longitude: 76.2 },
                    "喀什地区": { longitude: 75.9 },
                    "和田地区": { longitude: 79.9 },
                    "伊犁哈萨克自治州": { longitude: 81.3 },
                    "塔城地区": { longitude: 82.9 },
                    "阿勒泰地区": { longitude: 88.1 },
                    "石河子市": { longitude: 86.0 },
                    "阿拉尔市": { longitude: 81.2 },
                    "图木舒克市": { longitude: 79.0 },
                    "五家渠市": { longitude: 87.2 }
                },
                "香港特别行政区": { "香港": { longitude: 114.1 } },
                "澳门特别行政区": { "澳门": { longitude: 113.5 } },
                "台湾省": {
                    "台北市": { longitude: 121.5 },
                    "高雄市": { longitude: 120.3 }
                }
            };

            // ======================
            // 初始化省份列表
            // ======================
            function populateProvinces() {
                const provinceSelect = document.getElementById('birthProvince');
                provinceSelect.innerHTML = '<option value="">- 请选择省份 -</option>' + 
                    Object.keys(locationData).map(province => 
                        `<option value="${province}">${province}</option>`
                    ).join('');
            }

            // ======================
            // 初始化城市列表
            // ======================
            function populateCities(province) {
                const citySelect = document.getElementById('birthCity');
                const cities = locationData[province] || {};
                
                citySelect.innerHTML = '<option value="">- 请选择城市 -</option>' + 
                    Object.keys(cities).map(city => 
                        `<option value="${city}">${city}</option>`
                    ).join('');
            }

            function validateForm() {
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
                let isValid = true;

                const birthDateValue = birthDateInput.value;
                const birthHourValue = birthHourInput.value;
                const birthMinuteValue = birthMinuteInput.value;

                if (!birthDateValue) {
                    errorMessage.textContent += "请填写出生年月日。";
                    isValid = false;
                } else {
                    const dateParts = birthDateValue.split('-');
                    if (dateParts.length !== 3 || isNaN(parseInt(dateParts[0])) || isNaN(parseInt(dateParts[1])) || isNaN(parseInt(dateParts[2]))) {
                        errorMessage.textContent += "出生年月日格式不正确，应为 YYYY-MM-DD。";
                        isValid = false;
                    }
                }

                if (!birthHourValue) {
                    errorMessage.textContent += "请选择出生小时。";
                    isValid = false;
                }

                if (!birthMinuteValue) {
                    errorMessage.textContent += "请选择出生分钟。";
                    isValid = false;
                }

                if (!Array.from(genderRadios).some(radio => radio.checked)) {
                    errorMessage.textContent += "请选择性别。";
                    isValid = false;
                }
                if (!provinceSelect.value) {
                    errorMessage.textContent += "请选择出生省份/直辖市。"; // 修改提示信息
                    isValid = false;
                }
                if (!citySelect.value) {
                    errorMessage.textContent += "请选择出生城市。";
                    isValid = false;
                }

                if (!isValid) {
                    errorMessage.style.display = 'block';
                }
                return isValid;
            }

            function adjustDateTimeForLongitude(datetime, longitude) {
            // Adjust time based on longitude difference from Beijing (116.4°E)
            const beijingLongitude = 116.4;
            const timeDiffMinutes = Math.round((longitude - beijingLongitude) * 4); // 4 minutes per degree

            const adjustedTime = new Date(datetime.getTime() + timeDiffMinutes * 60 * 1000);
            return adjustedTime;
        }

        function calculateTenGod(dayStem, otherStem) {
            const tenGods = {
                "甲": {
                    "甲": "比肩", "乙": "劫财", "丙": "食神", "丁": "伤官",
                    "戊": "偏财", "己": "正财", "庚": "七杀", "辛": "正官",
                    "壬": "偏印", "癸": "正印"
                },
                "乙": {
                    "甲": "劫财", "乙": "比肩", "丙": "伤官", "丁": "食神",
                    "戊": "正财", "己": "偏财", "庚": "正官", "辛": "七杀",
                    "壬": "正印", "癸": "偏印"
                },
                "丙": {
                    "甲": "偏印", "乙": "正印", "丙": "比肩", "丁": "劫财",
                    "戊": "食神", "己": "伤官", "庚": "偏财", "辛": "正财",
                    "壬": "七杀", "癸": "正官"
                },
                "丁": {
                    "甲": "正印", "乙": "偏印", "丙": "劫财", "丁": "比肩",
                    "戊": "伤官", "己": "食神", "庚": "正财", "辛": "偏财",
                    "壬": "正官", "癸": "七杀"
                },
                "戊": {
                    "甲": "七杀", "乙": "正官", "丙": "偏印", "丁": "正印",
                    "戊": "比肩", "己": "劫财", "庚": "食神", "辛": "伤官",
                    "壬": "偏财", "癸": "正财"
                },
                "己": {
                    "甲": "正官", "乙": "七杀", "丙": "正印", "丁": "偏印",
                    "戊": "劫财", "己": "比肩", "庚": "伤官", "辛": "食神",
                    "壬": "正财", "癸": "偏财"
                },
                "庚": {
                    "甲": "偏财", "乙": "正财", "丙": "七杀", "丁": "正官",
                    "戊": "偏印", "己": "正印", "庚": "比肩", "辛": "劫财",
                    "壬": "食神", "癸": "伤官"
                },
                "辛": {
                    "甲": "正财", "乙": "偏财", "丙": "正官", "丁": "七杀",
                    "戊": "正印", "己": "偏印", "庚": "劫财", "辛": "比肩",
                    "壬": "伤官", "癸": "食神"
                },
                "壬": {
                    "甲": "食神", "乙": "伤官", "丙": "偏财", "丁": "正财",
                    "戊": "七杀", "己": "正官", "庚": "偏印", "辛": "正印",
                    "壬": "比肩", "癸": "劫财"
                },
                "癸": {
                    "甲": "伤官", "乙": "食神", "丙": "正财", "丁": "偏财",
                    "戊": "正官", "己": "七杀", "庚": "正印", "辛": "偏印",
                    "壬": "劫财", "癸": "比肩"
                }
            };

            return tenGods[dayStem][otherStem];
        }

        function calculateDayun(birthDate, gender, yearStem) {
            // Simple calculation for the demonstration
            // In a real application, this would be more complex using lunisolar's fate calculation
            const isMale = gender === '男';
            const stems = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"];
            const branches = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];

            // Get index of year stem
            const stemIndex = stems.indexOf(yearStem);

            // Determine direction based on gender and stem
            const forward = (isMale && stemIndex % 2 === 0) || (!isMale && stemIndex % 2 === 1);

            // Start year is typically around age 10
            const startYear = birthDate.getFullYear() + 10;

            // Generate dayun sequence
            const dayun = [];
            let currentStemIndex = stemIndex;
            let currentBranchIndex = branches.indexOf("寅"); // Example starting branch

            for (let i = 0; i < 8; i++) {
                const direction = forward ? 1 : -1;
                currentStemIndex = (currentStemIndex + direction + 10) % 10;
                currentBranchIndex = (currentBranchIndex + direction + 12) % 12;
                dayun.push(stems[currentStemIndex] + branches[currentBranchIndex]);
            }

            return {
                startYear: startYear,
                dayun: dayun
            };
        }

        function generateBaziPrompt(char8, gender, birthProvince, birthCity, bigLuck, birthYear) {
            const yearPillar = char8.year.toString();
            const monthPillar = char8.month.toString();
            const dayPillar = char8.day.toString();
            const hourPillar = char8.hour.toString();

            const dayStem = dayPillar[0];
            const yearTenGod = calculateTenGod(dayStem, yearPillar[0]);
            const monthTenGod = calculateTenGod(dayStem, monthPillar[0]);
            const hourTenGod = calculateTenGod(dayStem, hourPillar[0]);

            let prompt = "";
            prompt += `你是一位对中国传统八字命理学有着深刻理解和丰富经验的专家。你精通《滴天髓》、《子平真诠》、《穷通宝鉴》等经典著作，擅长运用五行生克、十神意象、格局喜忌等理论，对人生命运进行分析和解读。\n\n`;
            prompt += `现在你将面对一个八字命例，请你运用你的专业知识和经验，对该命例进行全面、深入的分析，并给出有价值的建议。请你务必逐步思考、推理，并清晰地展示你的思考过程。\n\n`;

            prompt += `求测者的基本信息如下：\n`;
            prompt += `性别：${gender}\n`;
            prompt += `出生地区：${birthProvince} ${birthCity}\n`;
            prompt += `出生年份：${birthYear}年\n\n`;

            prompt += `其八字命盘如下：\n`;
            // 四柱
            prompt += `年柱：${yearPillar}（${yearTenGod}）\n`;
            prompt += `月柱：${monthPillar}（${monthTenGod}）\n`;
            prompt += `日柱：${dayPillar}（日元）\n`;
            prompt += `时柱：${hourPillar}（${hourTenGod}）\n\n`;

            prompt += `大运信息：从${bigLuck.startYear}年起运，运程顺序为：${bigLuck.dayun.join('、')}\n\n`;

            prompt += `请你从以下几个方面入手，展开你的分析：\n\n`;

            prompt += `1.整体审视命局：首先，请你对命主进行八字排盘，从五行、阴阳、十神、格局等多个角度入手，对命局的整体特点进行概括性的描述。例如，五行是否均衡？阴阳是否协调？是否存在某种特殊的格局？日元得令、得地、得助吗？\n\n`;

            prompt += `2.分析日元强弱：日元代表命主自身，其强弱直接关系到命主的运势。请你结合月令、地支、天干等因素，综合判断日元的强弱，并说明判断的依据。如果日元偏强，喜什么？忌什么？如果日元偏弱，又该如何取用神？\n\n`;

            prompt += `3.剖析性格特征：性格决定命运。请你结合八字命盘，分析命主的性格特点、优缺点，以及可能的发展方向。例如，是积极进取还是保守稳重？是善于交际还是喜欢独处？是理性思维还是感性思维？这些性格特点对命主的人生有何影响？\n\n`;

            prompt += `4.推断事业发展：事业是人生价值的重要体现。请你结合八字命盘，分析命主的事业运势、适合的职业、发展方向等。例如，适合从事稳定的工作还是具有挑战性的工作？适合自己创业还是在企业中发展？在事业发展过程中需要注意哪些问题？\n\n`;

            prompt += `5.预测财富运势：财富是人生幸福的重要保障。请你结合八字命盘，分析命主的财富状况、财运走势、理财建议等。例如，是正财运旺盛还是偏财运旺盛？适合从事哪些行业的投资？在理财方面需要注意哪些问题？\n\n`;

            prompt += `6.研判婚姻情感：婚姻是人生重要的组成部分。请你结合八字命盘，分析命主的婚姻运势、情感状况、婚恋建议等。例如，是早婚好还是晚婚好？适合找什么样的伴侣？在婚姻中需要注意哪些问题？\n\n`;

            prompt += `7.关注健康状况：健康是幸福人生的基石。请你结合八字命盘，分析命主的健康状况、可能存在的健康隐患、养生建议等。例如，五行失衡可能导致哪些疾病？需要注意哪些方面的保健？\n\n`;

            prompt += `8.洞察六亲关系：六亲是与命主关系最为密切的人。请你结合八字命盘，分析命主与父母、配偶、子女等六亲的关系，以及六亲对命主的影响。例如，与父母的关系如何？配偶对自己有帮助吗？子女是否孝顺？\n\n`;

            prompt += `9.把握大运流年：大运和流年是影响命主运势的重要因素。请你结合大运和流年，分析命主在不同人生阶段的运势变化，为命主提供人生规划建议。例如，哪些年份是机遇期？哪些年份是挑战期？应该如何把握机遇、应对挑战？\n\n`;

            prompt += `在分析过程中，请你充分发挥你的聪明才智，运用你所掌握的命理学知识，结合实际情况，对命例进行深入的剖析和解读，并给出有价值的建议。\n\n`;
            prompt += `请记住，你的目标是帮助求测者更好地了解自己，把握命运，创造幸福的人生。\n\n`;
            prompt += `请开始你的分析吧！`;

            return prompt;
        }

            // 合并后的唯一按钮事件
            generateBtn.addEventListener('click', async function() {
                if (!validateForm() || typeof lunisolar === 'undefined') return;

                // 显示处理状态
                const processingBox = document.getElementById('processing-box');
                const stepsDiv = document.getElementById('processing-steps');
                processingBox.style.display = 'block';
                stepsDiv.innerHTML = '';
                processingMessageDiv.textContent = '正在初始化命理参数...';

                try {
                     // 初始化状态
                    processingBox.style.display = 'block';
                    stepsDiv.innerHTML = '';
                    llmOutputDiv.textContent = '';
                    apiErrorMessage.style.display = 'none';
                    
                    // 验证输入
                    if (!validateForm()) throw new Error('请填写完整信息');
                    processingMessageDiv.textContent = '正在初始化命理参数...';
                    
                                        
                    // 生成prompt（原逻辑）
                    const birthDateValue = birthDateInput.value;
                    const hourValue = birthHourInput.value;
                    const minuteValue = birthMinuteInput.value;
                    const birthDateTimeStr = `${birthDateValue} ${hourValue}:${minuteValue}`;
                    const gender = document.querySelector('input[name="gender"]:checked').value;
                    const birthProvince = provinceSelect.value;
                    const birthCity = citySelect.value;
                    const longitude = locationData[birthProvince][birthCity].longitude;

                    // 时间调整计算...
                    const birthDateTime = new Date(birthDateValue);
                    birthDateTime.setHours(parseInt(hourValue));
                    birthDateTime.setMinutes(parseInt(minuteValue));
                    const adjustedDateTime = adjustDateTimeForLongitude(birthDateTime, longitude);
                    const adjustedDateStr = adjustedDateTime.toISOString().slice(0, 16).replace('T', ' ');

                    // 生成八字信息
                    const lsr = lunisolar(birthDateTimeStr);
                    const char8 = lsr.char8;
                    const genderCode = gender === '男' ? 1 : 0;
                    const bigLuck = calculateDayun(birthDateTime, gender, char8.year.stem.toString());
                    const prompt = generateBaziPrompt(char8, gender, birthProvince, birthCity, bigLuck, birthDateTime.getFullYear());

                    // 显示处理进度
                    const steps = [
                        "正在连接量子服务器...",
                        "初始化神经网络...",
                        "加载命理数据库...",
                        "解析时空坐标...",
                        "构建五行模型...",
                        "进行量子推演...",
                        "生成最终报告..."
                    ];
                    let currentStep = 0;
                    const stepInterval = setInterval(() => {
                        if (currentStep < steps.length) {
                            stepsDiv.innerHTML += `𓀫 ${steps[currentStep]}<br>`;
                            processingMessageDiv.textContent = `进度: ${Math.round((currentStep+1)/steps.length*100)}%`;
                            currentStep++;
                        } else {
                            clearInterval(stepInterval);
                        }
                    }, 800);

                    const apiKey = llmApiKeyInput.value.trim();
                    if (!apiKey) {
                        throw new Error('需要API密钥启动量子演算');
                    }
                    const modelName = document.getElementById('llmModel').value || 'deepseek-r1';
                    
                    // 执行API调用
                    await callLLMAPI(prompt, apiKey, modelName);
                    
                } catch (error) {
                    // ======================
                    // 错误处理
                    // ======================
                    apiErrorMessage.textContent = `𓃣 系统错误: ${error.message}`;
                    apiErrorMessage.style.display = 'block';
                    console.error('Error:', error);
                    
                } finally {
                    // ======================
                    // 清理阶段
                    // ======================
                    clearInterval(stepInterval);
                    processingBox.style.display = 'none';
                }
            });


        

            async function callLLMAPI(prompt, apiKey, modelName) {
                try {
                    const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelName,
                            messages: [
                                {
                                    role: "system",
                                    content: "你是精通中国八字命理学的AI助手，能够用专业术语进行详细分析"
                                },
                                { role: "user", content: prompt }
                            ],
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API错误 (${response.status}): ${errorData.error?.message || '未知错误'}`);
                    }

                    // ======================
                    // 流式数据处理增强版
                    // ======================
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        
                        // 处理多行数据
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // 保留未完成部分
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    const content = data.choices[0]?.delta?.content || '';
                                    llmOutputDiv.textContent += content;
                                } catch (e) {
                                    console.warn('解析数据失败:', e);
                                }
                            }
                        }
                    }
                    
                } catch (error) {
                    throw new Error(`API通信失败: ${error.message}`);
                }
            }
    // Wait for lunisolar to load
    script.onload = function() {
            console.log("Lunisolar库已加载");
        };

        // ======================
        // 事件监听器
        // ======================
        document.getElementById('birthProvince').addEventListener('change', function() {
            populateCities(this.value);
        });

        // ======================
        // 初始化执行
        // ======================
        populateProvinces();
    });
    
    
    
    </script>
</body>
</html>