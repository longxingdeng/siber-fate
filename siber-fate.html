<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èµ›åšçŸ¥å‘½ - é‡å­å‘½ç†æ¼”ç®—ç³»ç»Ÿ</title>
    <style>
        :root {
            --cyber-gradient: linear-gradient(135deg, #00F3FF 0%, #2A0F37 50%, #FF00FF 100%);
            --cyber-purple: #2A0F37;
            --neon-pink: #FF00FF;
            --star-trail: #00F3FF;
            --matrix-green: #00FF00;
        }

        body {
            background: var(--cyber-purple);
            color: var(--star-trail);
            font-family: 'Orbitron', 'Noto Sans TC', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            scroll-behavior: smooth;
            margin: 20px;
            padding: 0;
        }

        /* æ–°å¢å¤„ç†çŠ¶æ€æ ·å¼ */
        .processing-box {
            border: 2px solid var(--star-trail);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.5);
            display: none;
        }
        .processing-steps {
            color: var(--matrix-green);
            font-size: 0.9em;
            margin: 1rem 0;
        }
        #processing-message {
            color: var(--star-trail);
            text-align: center;
            font-size: 1.1em;
        }


        /* é‡å­åœºåŸŸåˆ†éš”ç¬¦ */
        .nebula-divider {
            position: relative;
            margin: 2rem 0;
            border-top: 1px solid var(--neon-pink);
        }
        .nebula-divider::before {
            content: attr(data-text);
            position: absolute;
            top: -0.8em;
            left: 50%;
            transform: translateX(-50%);
            padding: 0 1rem;
            background: var(--cyber-purple);
            font-size: 0.9em;
            text-shadow: 0 0 10px var(--matrix-green);
        }

        .cyber-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border: 2px solid var(--star-trail);
            box-shadow: 0 0 30px var(--neon-pink);
            background: rgba(0, 0, 0, 0.8); /* æ¢å¤é»‘è‰²èƒŒæ™¯ */
            border-radius: 8px; /* ä¿ç•™åœ†è§’ */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* ä¿ç•™é˜´å½± */
        }

        .cyber-title {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            position: relative;
            margin: 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(45deg,
                rgba(0, 243, 255, 0.1) 0%,
                rgba(42, 15, 55, 0.3) 50%,
                rgba(255, 0, 255, 0.1) 100%);
            border: 2px solid var(--star-trail);
            box-shadow: 0 0 30px var(--neon-pink);
            color: #333;
        }

        .neon-subtitle {
            color: var(--star-trail);
            text-shadow: 0 0 5px var(--matrix-green);
            text-align: center;
            font-size: 1.2em;
            margin-top: -1rem;
        }

        .glitch-text {
            display: block;
            font-size: 3.5rem;
            color: var(--star-trail);
            text-shadow:
                2px 0 var(--neon-pink),
                -2px 0 var(--matrix-green),
                0 0 20px rgba(255,0,255,0.5);
            animation: glitch 2s infinite;
        }

        /* èµ›åšç„å­¦è¾“å…¥åŸŸ */
        .cyber-field {
            margin: 1.5rem 0;
            position: relative;
        }

        .neon-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1.1em;
            color: var(--star-trail); /*  æ”¹å›åŸæ¥çš„è“è‰²  */
            text-shadow: 0 0 2px var(--matrix-green); /*  å°†æ¨¡ç³ŠåŠå¾„ä» 5px å‡å°åˆ° 2px  */
            font-weight: bold;
            /* color: #555;  è¿™è¡Œå¯ä»¥åˆ é™¤ */
        }

        .hologram-text::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 1px;
            background: var(--cyber-gradient);
            opacity: 0.7;
        }
        .optional-tag {
            font-size: 0.8em;
            color: var(--star-trail);
            margin-left: 0.5em;
        }

        /* ææ€§æŒ¯è¡é€‰æ‹©å™¨ */
        .gender-selector {
            display: flex;
            gap: 2rem;
            margin: 1.5rem 0;
        }
        .quantum-polarity {
            position: relative;
            flex: 1;
            transition: transform 0.3s;
        }
        .quantum-polarity:hover {
            transform: translateY(-3px);
        }
        .polarity-label {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--star-trail);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .quantum-radio:checked + .polarity-label {
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 15px var(--star-trail);
        }
        .sigil {
            font-size: 1.5em;
            margin-right: 0.8rem;
        }

        /* æ—¶é—´æ‰°åŠ¨ç‰¹æ•ˆ */
        .temporal-input {
            position: relative;
            display: flex; /* Make temporal input container a flex container */
            align-items: center; /* Align items vertically in the center */
        }
        .temporal-input select, .temporal-input input[type="date"] {
            margin-right: 5px; /* Add some spacing between date/time selectors */
            width: auto; /* Adjust width as needed */
            flex: 1; /* Allow selectors to take available space */
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--star-trail);
            color: var(--star-trail);
            border-radius: 5px;
            appearance: none; /* Remove default dropdown arrow in some browsers */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            -moz-appearance: none; /* For Firefox */
            font-size: 16px;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 8px);
            background-position-y: center;
        }
        .timeshock-indicator {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: var(--matrix-green);
            box-shadow: 0 0 10px var(--matrix-green);
            animation: temporal-pulse 1.5s infinite;
        }

        .cyber-input {
            width: 100%;
            padding: 0.7rem;
            margin: 0.3rem 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--star-trail);
            color: var(--star-trail);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* Checkbox styles */
        .cyber-checkbox-field {
            margin: 1rem 0;
            display: flex;
            align-items: center;
        }
        .cyber-checkbox {
            appearance: none; /* Remove default checkbox appearance */
            -webkit-appearance: none; /* For Safari */
            -moz-appearance: none; /* For Firefox */
            width: 20px;
            height: 20px;
            border: 2px solid var(--star-trail);
            background-color: transparent;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }
        .cyber-checkbox:checked {
            background-color: var(--star-trail);
            border-color: var(--star-trail);
        }
        .cyber-checkbox:checked::after {
            content: '\2714'; /* Checkmark character */
            font-size: 16px;
            color: var(--cyber-purple);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .cyber-checkbox-label {
            margin-left: 0.5rem;
            color: var(--star-trail);
            font-size: 0.9em;
        }

        /* Submit button */
         .cyber-submit-button {
            padding: 1rem 2rem;
            background:linear-gradient(135deg, #000080 0%, #00FFFF 100%); /* æ·±è“åˆ°äº®é’ */
            color: white; /* ä¿®æ”¹æ–‡å­—é¢œè‰²ä¸ºç™½è‰² */
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.3s;
            display: block;
            margin: 2rem auto;
            box-shadow: 0 0 15px var(--neon-pink);
        }

        .cyber-submit-button:hover {
            transform: scale(1.05);
        }

        #generate-btn {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            margin-top: 1rem;
            background:linear-gradient(135deg, #000080 0%, #00FFFF 100%);
            box-shadow: 0 0 15px var(--neon-pink);
        }

        #generate-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        #error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }

        #api-error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }

        pre {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            position: relative;
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--star-trail);
            border: 1px solid var(--star-trail);
            box-shadow: 0 0 15px var(--neon-pink);
            margin-top: 1rem;
        }

        .form-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--neon-pink);
            margin-bottom: 1.5rem;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background:linear-gradient(135deg, #000080 0%, #00FFFF 100%);
            box-shadow: 0 0 10px var(--neon-pink);
        }

        .copy-btn:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }

        #llm-output {
            white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œå’Œç©ºæ ¼ */
        }

        #processing-message {
            color: var(--star-trail);
            text-align: center;
            margin-top: 1rem;
            display: none; /* Initially hidden */
        }

        @keyframes glitch {
            0% { transform: translate(2px, 0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(0, -1px); }
            60% { transform: translate(1px, 1px); }
            80% { transform: translate(-1px, -1px); }
            100% { transform: translate(0, 0); }
        }
        @keyframes temporal-pulse {
            0% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0.3; transform: scale(1); }
        }

        /* ä¿ç•™åŸæœ‰é‡å­èƒŒæ™¯å’Œæ»šåŠ¨æ¡æ ·å¼ */
        .quantum-bg { position: fixed; z-index: -1; }
        ::-webkit-scrollbar { width: 10px; background: rgba(0, 243, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: var(--cyber-gradient); }

        /* Dropdown arrow styling for consistency across browsers */
        select.cyber-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position-x: calc(100% - 8px);
            background-position-y: center;
        }

        .date-group {
            display: flex;
            gap: 10px;
        }

        .date-group input {
            width: 33%;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-group label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        input[type="radio"] {
            margin: 0;
        }

    </style>
</head>
<body>
    <canvas class="quantum-bg"></canvas>

    <div class="cyber-container">
        <h1 class="cyber-title">
            <span class="glitch-text">ğ“Š– èµ›åšçŸ¥å‘½</span>
            <div class="neon-subtitle">é‡å­å‘½ç†æ¼”ç®—ç³»ç»Ÿ v2.0</div>
        </h1>

        <div class="quantum-form">
            <div class="nebula-divider" data-text="ğ“œ é‡å­çº ç¼ é”šç‚¹"></div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">å§“æ°(å»ºè­°ä½¿ç”¨ç¹é«”å­—)</span>
                    <span class="optional-tag">ï¼ˆé€‰å¡«ï¼‰</span>
                </label>
                <input type="text" class="cyber-input"
                     placeholder="è¯·è¾“å…¥å§“æ°">
            </div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">åå­—(å»ºè­°ä½¿ç”¨ç¹é«”å­—)</span>
                    <span class="optional-tag">ï¼ˆé€‰å¡«ï¼‰</span>
                </label>
                <input type="text" class="cyber-input"
                     placeholder="è¯·è¾“å…¥åå­—">
            </div>

            <div class="cyber-field">
                <label class="neon-label">æ€§åˆ«:</label>
                <div class="gender-selector">
                    <div class="quantum-polarity" data-polarity="â™‚">
                        <input type="radio" name="gender" id="male"
                             class="quantum-radio" value="ä¹¾é€ " hidden>
                        <label for="male" class="polarity-label">
                            <span class="sigil">ğ“›</span>
                            <span class="polarity-text">ç”·</span >
                        </label>
                    </div>
                    <div class="quantum-polarity" data-polarity="â™€">
                        <input type="radio" name="gender" id="female"
                             class="quantum-radio" value="å¤é€ " hidden>
                        <label for="female" class="polarity-label">
                            <span class="sigil">ğ“Ÿ</span>
                            <span class="polarity-text">å¥³</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">é˜³å†å‡ºç”Ÿå¹´æœˆæ—¥æ—¶åˆ† | è¯·ç”¨+8æ—¶åŒº:</span>
                </label>
                <div class="temporal-input">
                    <input type="date" class="cyber-input" id="birthDate">
                    <select class="cyber-input" id="birthHour">
                        <option value="">-- æ—¶ --</option>
                        <option value="00">00</option> <option value="01">01</option> <option value="02">02</option> <option value="03">03</option> <option value="04">04</option> <option value="05">05</option> <option value="06">06</option> <option value="07">07</option> <option value="08">08</option> <option value="09">09</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option>
                    </select>
                    <select class="cyber-input" id="birthMinute">
                        <option value="">-- åˆ† --</option>
                        <option value="00">00</option> <option value="01">01</option> <option value="02">02</option> <option value="03">03</option> <option value="04">04</option> <option value="05">05</option> <option value="06">06</option> <option value="07">07</option> <option value="08">08</option> <option value="09">09</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> <option value="13">13</option> <option value="14">14</option> <option value="15">15</option> <option value="16">16</option> <option value="17">17</option> <option value="18">18</option> <option value="19">19</option> <option value="20">20</option> <option value="21">21</option> <option value="22">22</option> <option value="23">23</option> <option value="24">24</option> <option value="25">25</option> <option value="26">26</option> <option value="27">27</option> <option value="28">28</option> <option value="29">29</option> <option value="30">30</option> <option value="31">31</option> <option value="32">32</option> <option value="33">33</option> <option value="34">34</option> <option value="35">35</option> <option value="36">36</option> <option value="37">37</option> <option value="38">38</option> <option value="39">39</option> <option value="40">40</option> <option value="41">41</option> <option value="42">42</option> <option value="43">43</option> <option value="44">44</option> <option value="45">45</option> <option value="46">46</option> <option value="47">47</option> <option value="48">48</option> <option value="49">49</option> <option value="50">50</option> <option value="51">51</option> <option value="52">52</option> <option value="53">53</option> <option value="54">54</option> <option value="55">55</option> <option value="56">56</option> <option value="57">57</option> <option value="58">58</option> <option value="59">59</option>
                    </select>
                    <div class="timeshock-indicator"></div>
                </div>
            </div>

            <div class="cyber-field">
                <label class="neon-label">å‡ºç”Ÿçœä»½/ç›´è¾–å¸‚:</label>
                <select class="cyber-input" id="birthProvince">
                    <option value="">- è¯·é€‰æ‹©çœä»½ -</option>

                    <!-- Add more countries as needed -->
                </select>
            </div>

            <div class="cyber-field">
                <label class="neon-label">å‡ºç”ŸåŸå¸‚:</label>
                <select class="cyber-input" id="birthCity">
                    <option value="">- è¯·é€‰æ‹©åŸå¸‚ -</option>
                    <!-- Add more cities as needed, potentially based on country selection -->
                </select>
            </div>

            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">è‡ªå®šä¹‰ç»åº¦ (é€‰å¡«)</span>
                </label>
                <input type="text" class="cyber-input" placeholder="ä¾‹å¦‚: 121.5">
                <p style="font-size: 0.8em; margin-top: 0.3rem;">è‹¥å¡«å†™æ­¤æ ä½å°†ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰ç»åº¦ (æœ‰æ•ˆèŒƒå›´: -180 åˆ° 180ï¼Œä¸œç»ä¸ºæ­£å€¼)</p>
            </div>

            <div class="cyber-field">
                <label class="neon-label">æ¨¡å‹é€‰æ‹© (Model):</label>
                <select class="cyber-input" id="llmModel">
                    <option value="deepseek-r1">deepseek-r1 (é«˜æ€§èƒ½æ¨¡å‹)</option>
                    <option value="deepseek-v3">deepseek-v3 (ç»æµå‹æ¨¡å‹)</option>
                    <!-- Add more model options as needed -->
                </select>
            </div>

            <div class="cyber-checkbox-field">
                <input type="checkbox" class="cyber-checkbox" id="useSolarTime" checked>
                <label for="useSolarTime" class="cyber-checkbox-label">ä½¿ç”¨çœŸå¤ªé˜³æ—¶:</label>
            </div>

            <div class="cyber-checkbox-field">
                <input type="checkbox" class="cyber-checkbox" id="addZiWeiDouShu" checked>
                <label for="addZiWeiDouShu" class="cyber-checkbox-label">åŠ å…¥ç´«å¾®æ–—æ•°:</label>
            </div>

            <div class="nebula-divider" data-text="ğŸ”‘ API å¯†é’¥ (LLM)"></div>
            <div class="cyber-field">
                <label class="neon-label">
                    <span class="hologram-text">API å¯†é’¥</span>
                </label>
                <input type="password" class="cyber-input" id="llmApiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„ API å¯†é’¥">
            </div>
            
            <!-- æ–°å¢å¤„ç†çŠ¶æ€æ˜¾ç¤º -->
            <div class="processing-box" id="processing-box">
                <div class="neon-label">ğ“‚€ é‡å­æ¼”ç®—è¿›åº¦</div>
                <div class="processing-steps" id="processing-steps"></div>
                <div id="processing-message">åˆå§‹åŒ–é‡å­åœºåŸŸ...</div>
            </div>

            <button id="generate-btn" class="cyber-submit-button">ğ“ƒ  å¯åŠ¨é‡å­æ¼”ç®—</button>
            <div id="error-message"></div>
            <div id="api-error-message"></div>
            
            <h2 class="neon-label">ğ“Ÿ æ¼”ç®—ç»“æœ:</h2>
            <pre id="llm-output"></pre>

            <div class="nebula-divider" data-text="é‡è¦å£°æ˜"></div>
            <div style="color: var(--neon-blue); font-size: 0.9em; text-align: center; margin-bottom: 1rem;">
                å‘½ç†å­¦æ˜¯ä¸€ç§å¤æ‚çš„å­¦é—®ä»…ä¾›å‚è€ƒï¼Œä¸èƒ½ä½œä¸ºå†³ç­–çš„å”¯ä¸€ä¾æ®ã€‚
            </div>
        </div>
    </div>

        <!-- ä¿ç•™åŸæœ‰æ˜Ÿå›¾å’Œç»“æœåŒºåŸŸ -->
        <div class="destiny-canvas" id="starMap"></div>
        <div id="quantumResult"></div>
    </div>

    <script>
        // ä¼˜åŒ–åçš„é‡å­èƒŒæ™¯ï¼ˆå¢åŠ ç²’å­çº ç¼ æ•ˆæœï¼‰
        class QuantumBackground {
            constructor() {
                this.canvas = document.querySelector('.quantum-bg');
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.init();
                this.animate();
            }

            init() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;

                // ç”Ÿæˆçº ç¼ ç²’å­å¯¹
                for(let i = 0; i < 100; i++) {
                    const baseX = Math.random() * this.canvas.width;
                    const baseY = Math.random() * this.canvas.height;
                    this.particles.push(this.createEntangledPair(baseX, baseY));
                }
            }

            createEntangledPair(x, y) {
                return {
                    pair: [
                        { x, y, vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3 },
                        { x, y, vx: -this.vx, vy: -this.vy }
                    ],
                    size: Math.random() * 2,
                    color: Math.random() > 0.5 ? '#00F3FF' : '#FF00FF'
                };
            }

            animate() {
                this.ctx.fillStyle = 'rgba(42, 15, 55, 0.05)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                this.particles.forEach(entangledPair => {
                    entangledPair.pair.forEach(particle => {
                        particle.x += particle.vx;
                        particle.y += particle.vy;

                        // è¾¹ç•Œåå¼¹
                        if(particle.x < 0 || particle.x > this.canvas.width) particle.vx *= -1;
                        if(particle.y < 0 || particle.y > this.canvas.height) particle.vy *= -1;

                        // ç»˜åˆ¶çº ç¼ ç²’å­
                        this.ctx.beginPath();
                        this.ctx.arc(particle.x, particle.y, entangledPair.size, 0, Math.PI*2);
                        this.ctx.fillStyle = entangledPair.color;
                        this.ctx.fill();
                    });

                    // ç»˜åˆ¶çº ç¼ å…‰æŸ
                    const [p1, p2] = entangledPair.pair;
                    this.ctx.beginPath();
                    this.ctx.moveTo(p1.x, p1.y);
                    this.ctx.lineTo(p2.x, p2.y);
                    this.ctx.strokeStyle = `${entangledPair.color}30`;
                    this.ctx.lineWidth = 0.3;
                    this.ctx.stroke();
                });

                requestAnimationFrame(() => this.animate());
            }
        }
        new QuantumBackground();

        // å¢å¼ºææ€§é€‰æ‹©äº¤äº’
        document.querySelectorAll('.quantum-polarity').forEach(container => {
            container.addEventListener('click', () => {
                const currentActive = document.querySelector('.quantum-radio:checked');
                if (currentActive) currentActive.parentElement.classList.remove('active');
                container.querySelector('.quantum-radio').checked = true;
                container.classList.add('active');
            });
        });

 //Add script tag for lunisolar
 const script = document.createElement('script');
        script.src = "https://unpkg.com/lunisolar@2.5.1/dist/lunisolar.js";
        script.onload = function() {
            const takeSoundScript = document.createElement('script');
            takeSoundScript.src = "https://unpkg.com/@lunisolar/plugin-takesound@0.1.2/dist/index.js";
            document.head.appendChild(takeSoundScript);
        };
        script.onerror = function() {
            console.error("é”™è¯¯ï¼šåŠ è½½ lunisolar è„šæœ¬å¤±è´¥");
        };
        document.head.appendChild(script);

        document.addEventListener('DOMContentLoaded', function() {
            const birthDateInput = document.getElementById('birthDate');
            const birthHourInput = document.getElementById('birthHour');
            const birthMinuteInput = document.getElementById('birthMinute');
            const genderRadios = document.getElementsByName('gender');
            const provinceSelect = document.getElementById('birthProvince');
            const citySelect = document.getElementById('birthCity');
            const generateBtn = document.getElementById('generate-btn');
            const startCalculationBtn = document.getElementById('start-calculation-btn'); // New button
            const errorMessage = document.getElementById('error-message');
            const apiErrorMessage = document.getElementById('api-error-message');
            const outputDiv = document.getElementById('output');
            const llmOutputDiv = document.getElementById('llm-output');
            const processingMessageDiv = document.getElementById('processing-message');
            const llmApiKeyInput = document.getElementById('llmApiKey');
            const llmModelSelect = document.getElementById('llmModel'); // è·å–æ¨¡å‹é€‰æ‹©çš„å…ƒç´   **æ·»åŠ äº†è¿™ä¸€è¡Œ**
            const processingBox = document.getElementById('processing-box');
            const stepsDiv = document.getElementById('processing-steps');




            const locationData = {
                "åŒ—äº¬å¸‚": { "åŒ—äº¬å¸‚": { longitude: 116.4 } },
                "å¤©æ´¥å¸‚": { "å¤©æ´¥å¸‚": { longitude: 117.2 } },
                "æ²³åŒ—çœ": {
                    "çŸ³å®¶åº„å¸‚": { longitude: 114.5 },
                    "å”å±±å¸‚": { longitude: 118.2 },
                    "ç§¦çš‡å²›å¸‚": { longitude: 119.6 },
                    "é‚¯éƒ¸å¸‚": { longitude: 114.5 },
                    "é‚¢å°å¸‚": { longitude: 114.5 },
                    "ä¿å®šå¸‚": { longitude: 115.5 },
                    "å¼ å®¶å£å¸‚": { longitude: 114.9 },
                    "æ‰¿å¾·å¸‚": { longitude: 117.9 },
                    "æ²§å·å¸‚": { longitude: 116.8 },
                    "å»ŠåŠå¸‚": { longitude: 116.7 },
                    "è¡¡æ°´å¸‚": { longitude: 115.7 }
                },
                "å±±è¥¿çœ": {
                    "å¤ªåŸå¸‚": { longitude: 112.5 },
                    "å¤§åŒå¸‚": { longitude: 113.3 },
                    "é˜³æ³‰å¸‚": { longitude: 113.6 },
                    "é•¿æ²»å¸‚": { longitude: 113.1 },
                    "æ™‹åŸå¸‚": { longitude: 112.8 },
                    "æœ”å·å¸‚": { longitude: 112.4 },
                    "æ™‹ä¸­å¸‚": { longitude: 112.7 },
                    "è¿åŸå¸‚": { longitude: 111.0 },
                    "å¿»å·å¸‚": { longitude: 112.7 },
                    "ä¸´æ±¾å¸‚": { longitude: 111.5 },
                    "å•æ¢å¸‚": { longitude: 111.1 }
                },
                "å†…è’™å¤è‡ªæ²»åŒº": {
                    "å‘¼å’Œæµ©ç‰¹å¸‚": { longitude: 111.7 },
                    "åŒ…å¤´å¸‚": { longitude: 110.0 },
                    "ä¹Œæµ·å¸‚": { longitude: 118.3 },
                    "èµ¤å³°å¸‚": { longitude: 118.9 },
                    "é€šè¾½å¸‚": { longitude: 122.2 },
                    "é„‚å°”å¤šæ–¯å¸‚": { longitude: 109.8 },
                    "å‘¼ä¼¦è´å°”å¸‚": { longitude: 119.7 },
                    "å·´å½¦æ·–å°”å¸‚": { longitude: 107.4 },
                    "ä¹Œå…°å¯Ÿå¸ƒå¸‚": { longitude: 113.2 },
                    "å…´å®‰ç›Ÿ": { longitude: 122.1 },
                    "é”¡æ—éƒ­å‹’ç›Ÿ": { longitude: 116.0 },
                    "é˜¿æ‹‰å–„ç›Ÿ": { longitude: 105.7 }
                },
                "è¾½å®çœ": {
                    "æ²ˆé˜³å¸‚": { longitude: 123.4 },
                    "å¤§è¿å¸‚": { longitude: 121.6 },
                    "éå±±å¸‚": { longitude: 122.9 },
                    "æŠšé¡ºå¸‚": { longitude: 123.9 },
                    "æœ¬æºªå¸‚": { longitude: 123.7 },
                    "ä¸¹ä¸œå¸‚": { longitude: 124.3 },
                    "é”¦å·å¸‚": { longitude: 121.1 },
                    "è¥å£å¸‚": { longitude: 122.2 },
                    "é˜œæ–°å¸‚": { longitude: 121.6 },
                    "è¾½é˜³å¸‚": { longitude: 123.2 },
                    "ç›˜é”¦å¸‚": { longitude: 122.0 },
                    "é“å²­å¸‚": { longitude: 123.8 },
                    "æœé˜³å¸‚": { longitude: 120.4 },
                    "è‘«èŠ¦å²›å¸‚": { longitude: 120.8 }
                },
                "å‰æ—çœ": {
                    "é•¿æ˜¥å¸‚": { longitude: 125.3 },
                    "å‰æ—å¸‚": { longitude: 126.5 },
                    "å››å¹³å¸‚": { longitude: 124.3 },
                    "è¾½æºå¸‚": { longitude: 125.1 },
                    "é€šåŒ–å¸‚": { longitude: 125.9 },
                    "ç™½å±±å¸‚": { longitude: 126.4 },
                    "æ¾åŸå¸‚": { longitude: 124.8 },
                    "ç™½åŸå¸‚": { longitude: 122.8 },
                    "å»¶è¾¹æœé²œæ—è‡ªæ²»å·": { longitude: 129.5 }
                },
                "é»‘é¾™æ±Ÿçœ": {
                    "å“ˆå°”æ»¨å¸‚": { longitude: 126.6 },
                    "é½é½å“ˆå°”å¸‚": { longitude: 123.9 },
                    "é¸¡è¥¿å¸‚": { longitude: 130.9 },
                    "é¹¤å²—å¸‚": { longitude: 130.3 },
                    "åŒé¸­å±±å¸‚": { longitude: 131.1 },
                    "å¤§åº†å¸‚": { longitude: 125.1 },
                    "ä¼Šæ˜¥å¸‚": { longitude: 129.0 },
                    "ä½³æœ¨æ–¯å¸‚": { longitude: 130.3 },
                    "ä¸ƒå°æ²³å¸‚": { longitude: 130.9 },
                    "ç‰¡ä¸¹æ±Ÿå¸‚": { longitude: 129.6 },
                    "é»‘æ²³å¸‚": { longitude: 127.5 },
                    "ç»¥åŒ–å¸‚": { longitude: 126.9 },
                    "å¤§å…´å®‰å²­åœ°åŒº": { longitude: 124.7 }
                },
                "ä¸Šæµ·å¸‚": { "ä¸Šæµ·å¸‚": { longitude: 121.4 } },
                "æ±Ÿè‹çœ": {
                    "å—äº¬å¸‚": { longitude: 118.8 },
                    "æ— é”¡å¸‚": { longitude: 120.3 },
                    "å¾å·å¸‚": { longitude: 117.2 },
                    "å¸¸å·å¸‚": { longitude: 119.9 },
                    "è‹å·å¸‚": { longitude: 120.6 },
                    "å—é€šå¸‚": { longitude: 120.8 },
                    "è¿äº‘æ¸¯å¸‚": { longitude: 119.2 },
                    "æ·®å®‰å¸‚": { longitude: 119.0 },
                    "ç›åŸå¸‚": { longitude: 120.1 },
                    "æ‰¬å·å¸‚": { longitude: 119.4 },
                    "é•‡æ±Ÿå¸‚": { longitude: 119.4 },
                    "æ³°å·å¸‚": { longitude: 119.9 },
                    "å®¿è¿å¸‚": { longitude: 118.3 }
                },
                "æµ™æ±Ÿçœ": {
                    "æ­å·å¸‚": { longitude: 120.2 },
                    "å®æ³¢å¸‚": { longitude: 121.5 },
                    "æ¸©å·å¸‚": { longitude: 120.6 },
                    "å˜‰å…´å¸‚": { longitude: 120.7 },
                    "æ¹–å·å¸‚": { longitude: 120.1 },
                    "ç»å…´å¸‚": { longitude: 120.5 },
                    "é‡‘åå¸‚": { longitude: 119.6 },
                    "è¡¢å·å¸‚": { longitude: 118.8 },
                    "èˆŸå±±å¸‚": { longitude: 122.3 },
                    "å°å·å¸‚": { longitude: 121.4 },
                    "ä¸½æ°´å¸‚": { longitude: 119.9 }
                },
                "å®‰å¾½çœ": {
                    "åˆè‚¥å¸‚": { longitude: 117.3 },
                    "èŠœæ¹–å¸‚": { longitude: 118.3 },
                    "èšŒåŸ å¸‚": { longitude: 117.3 },
                    "æ·®å—å¸‚": { longitude: 116.7 },
                    "é©¬éå±±å¸‚": { longitude: 118.5 },
                    "æ·®åŒ—å¸‚": { longitude: 116.8 },
                    "é“œé™µå¸‚": { longitude: 117.8 },
                    "å®‰åº†å¸‚": { longitude: 117.0 },
                    "é»„å±±å¸‚": { longitude: 118.3 },
                    "æ»å·å¸‚": { longitude: 118.3 },
                    "é˜œé˜³å¸‚": { longitude: 115.8 },
                    "å®¿å·å¸‚": { longitude: 116.9 },
                    "å…­å®‰å¸‚": { longitude: 116.5 },
                    "äº³å·å¸‚": { longitude: 115.7 },
                    "æ± å·å¸‚": { longitude: 117.4 },
                    "å®£åŸå¸‚": { longitude: 118.7 }
                },
                "ç¦å»ºçœ": {
                    "ç¦å·å¸‚": { longitude: 119.3 },
                    "å¦é—¨å¸‚": { longitude: 118.1 },
                    "è†ç”°å¸‚": { longitude: 119.0 },
                    "ä¸‰æ˜å¸‚": { longitude: 117.6 },
                    "æ³‰å·å¸‚": { longitude: 118.6 },
                    "æ¼³å·å¸‚": { longitude: 117.6 },
                    "å—å¹³å¸‚": { longitude: 118.0 },
                    "é¾™å²©å¸‚": { longitude: 117.0 },
                    "å®å¾·å¸‚": { longitude: 119.5 }
                },
                "æ±Ÿè¥¿çœ": {
                    "å—æ˜Œå¸‚": { longitude: 115.9 },
                    "æ™¯å¾·é•‡å¸‚": { longitude: 117.2 },
                    "èä¹¡å¸‚": { longitude: 113.8 },
                    "ä¹æ±Ÿå¸‚": { longitude: 116.0 },
                    "æ–°ä½™å¸‚": { longitude: 114.9 },
                    "é¹°æ½­å¸‚": { longitude: 117.0 },
                    "èµ£å·å¸‚": { longitude: 114.9 },
                    "å®œæ˜¥å¸‚": { longitude: 114.4 },
                    "ä¸Šé¥¶å¸‚": { longitude: 117.9 },
                    "å‰å®‰å¸‚": { longitude: 114.9 },
                    "æŠšå·å¸‚": { longitude: 116.3 }
                },
                "å±±ä¸œçœ": {
                    "æµå—å¸‚": { longitude: 117.0 },
                    "é’å²›å¸‚": { longitude: 120.3 },
                    "æ·„åšå¸‚": { longitude: 118.0 },
                    "æ£åº„å¸‚": { longitude: 117.5 },
                    "ä¸œè¥å¸‚": { longitude: 118.5 },
                    "çƒŸå°å¸‚": { longitude: 121.4 },
                    "æ½åŠå¸‚": { longitude: 119.1 },
                    "æµå®å¸‚": { longitude: 116.5 },
                    "æ³°å®‰å¸‚": { longitude: 117.1 },
                    "å¨æµ·å¸‚": { longitude: 122.1 },
                    "æ—¥ç…§å¸‚": { longitude: 119.5 },
                    "æ»¨å·å¸‚": { longitude: 118.0 },
                    "å¾·å·å¸‚": { longitude: 116.3 },
                    "èŠåŸå¸‚": { longitude: 115.9 },
                    "ä¸´æ²‚å¸‚": { longitude: 118.3 },
                    "èæ³½å¸‚": { longitude: 115.4 }
                },
                "æ²³å—çœ": {
                    "éƒ‘å·å¸‚": { longitude: 113.6 },
                    "å¼€å°å¸‚": { longitude: 114.3 },
                    "æ´›é˜³å¸‚": { longitude: 112.4 },
                    "å¹³é¡¶å±±å¸‚": { longitude: 113.3 },
                    "å®‰é˜³å¸‚": { longitude: 114.3 },
                    "é¹¤å£å¸‚": { longitude: 114.3 },
                    "æ–°ä¹¡å¸‚": { longitude: 113.9 },
                    "ç„¦ä½œå¸‚": { longitude: 113.2 },
                    "æ¿®é˜³å¸‚": { longitude: 115.0 },
                    "è®¸æ˜Œå¸‚": { longitude: 113.8 },
                    "æ¼¯æ²³å¸‚": { longitude: 114.0 },
                    "ä¸‰é—¨å³¡å¸‚": { longitude: 111.9 },
                    "å—é˜³å¸‚": { longitude: 112.5 },
                    "å•†ä¸˜å¸‚": { longitude: 115.6 },
                    "ä¿¡é˜³å¸‚": { longitude: 114.0 },
                    "å‘¨å£å¸‚": { longitude: 114.6 },
                    "é©»é©¬åº—å¸‚": { longitude: 114.0 },
                    "æµæºå¸‚": { longitude: 112.6 }
                },
                "æ¹–åŒ—çœ": {
                    "æ­¦æ±‰å¸‚": { longitude: 114.3 },
                    "é»„çŸ³å¸‚": { longitude: 114.9 },
                    "åå °å¸‚": { longitude: 110.7 },
                    "å®œæ˜Œå¸‚": { longitude: 111.3 },
                    "è¥„é˜³å¸‚": { longitude: 112.1 },
                    "é„‚å·å¸‚": { longitude: 114.8 },
                    "è†é—¨å¸‚": { longitude: 112.2 },
                    "å­æ„Ÿå¸‚": { longitude: 113.9 },
                    "è†å·å¸‚": { longitude: 112.2 },
                    "é»„å†ˆå¸‚": { longitude: 114.8 },
                    "å’¸å®å¸‚": { longitude: 114.3 },
                    "éšå·å¸‚": { longitude: 113.3 },
                    "æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·": { longitude: 109.4 },
                    "ä»™æ¡ƒå¸‚": { longitude: 113.4 },
                    "æ½œæ±Ÿå¸‚": { longitude: 112.9 },
                    "å¤©é—¨å¸‚": { longitude: 113.1 },
                    "ç¥å†œæ¶æ—åŒº": { longitude: 110.3 }
                },
                "æ¹–å—çœ": {
                    "é•¿æ²™å¸‚": { longitude: 113.0 },
                    "æ ªæ´²å¸‚": { longitude: 113.1 },
                    "æ¹˜æ½­å¸‚": { longitude: 112.9 },
                    "è¡¡é˜³å¸‚": { longitude: 112.6 },
                    "é‚µé˜³å¸‚": { longitude: 111.4 },
                    "å²³é˜³å¸‚": { longitude: 113.1 },
                    "å¸¸å¾·å¸‚": { longitude: 111.6 },
                    "å¼ å®¶ç•Œå¸‚": { longitude: 110.4 },
                    "ç›Šé˜³å¸‚": { longitude: 112.3 },
                    "éƒ´å·å¸‚": { longitude: 113.0 },
                    "æ°¸å·å¸‚": { longitude: 111.6 },
                    "æ€€åŒ–å¸‚": { longitude: 110.0 },
                    "å¨„åº•å¸‚": { longitude: 112.0 },
                    "æ¹˜è¥¿åœŸå®¶æ—è‹—æ—è‡ªæ²»å·": { longitude: 109.7 }
                },
                "å¹¿ä¸œçœ": {
                    "å¹¿å·å¸‚": { longitude: 113.2 },
                    "éŸ¶å…³å¸‚": { longitude: 113.6 },
                    "æ·±åœ³å¸‚": { longitude: 114.0 },
                    "ç æµ·å¸‚": { longitude: 113.5 },
                    "æ±•å¤´å¸‚": { longitude: 116.6 },
                    "ä½›å±±å¸‚": { longitude: 113.1 },
                    "æ±Ÿé—¨å¸‚": { longitude: 113.0 },
                    "æ¹›æ±Ÿå¸‚": { longitude: 110.3 },
                    "èŒ‚åå¸‚": { longitude: 110.8 },
                    "è‚‡åº†å¸‚": { longitude: 112.4 },
                    "æƒ å·å¸‚": { longitude: 114.4 },
                    "æ¢…å·å¸‚": { longitude: 116.1 },
                    "æ±•å°¾å¸‚": { longitude: 115.3 },
                    "æ²³æºå¸‚": { longitude: 114.6 },
                    "é˜³æ±Ÿå¸‚": { longitude: 111.9 },
                    "æ¸…è¿œå¸‚": { longitude: 113.0 },
                    "ä¸œèå¸‚": { longitude: 113.7 },
                    "ä¸­å±±å¸‚": { longitude: 113.3 },
                    "æ½®å·å¸‚": { longitude: 116.6 },
                    "æ­é˜³å¸‚": { longitude: 116.3 },
                    "äº‘æµ®å¸‚": { longitude: 112.0 }
                },
                "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº": {
                    "å—å®å¸‚": { longitude: 108.3 },
                    "æŸ³å·å¸‚": { longitude: 109.4 },
                    "æ¡‚æ—å¸‚": { longitude: 110.2 },
                    "æ¢§å·å¸‚": { longitude: 111.3 },
                    "åŒ—æµ·å¸‚": { longitude: 109.1 },
                    "é˜²åŸæ¸¯å¸‚": { longitude: 108.3 },
                    "é’¦å·å¸‚": { longitude: 108.6 },
                    "è´µæ¸¯å¸‚": { longitude: 109.5 },
                    "ç‰æ—å¸‚": { longitude: 110.1 },
                    "ç™¾è‰²å¸‚": { longitude: 106.6 },
                    "è´ºå·å¸‚": { longitude: 111.5 },
                    "æ²³æ± å¸‚": { longitude: 107.9 },
                    "æ¥å®¾å¸‚": { longitude: 109.2 },
                    "å´‡å·¦å¸‚": { longitude: 107.3 }
                },
                "æµ·å—çœ": {
                    "æµ·å£å¸‚": { longitude: 110.3 },
                    "ä¸‰äºšå¸‚": { longitude: 109.5 },
                    "ä¸‰æ²™å¸‚": { longitude: 112.3 },
                    "å„‹å·å¸‚": { longitude: 109.5 },
                    "æ–‡æ˜Œå¸‚": { longitude: 110.7 },
                    "ç¼æµ·å¸‚": { longitude: 110.4 },
                    "ä¸‡å®å¸‚": { longitude: 110.4 },
                    "äº”æŒ‡å±±å¸‚": { longitude: 109.5 },
                    "ä¸œæ–¹å¸‚": { longitude: 108.6 },
                    "å®šå®‰å¿": { longitude: 110.3 },
                    "å±¯æ˜Œå¿": { longitude: 109.9 },
                    "æ¾„è¿ˆå¿": { longitude: 110.0 },
                    "ä¸´é«˜å¿": { longitude: 109.7 },
                    "ç™½æ²™é»æ—è‡ªæ²»å¿": { longitude: 109.4 },
                    "æ˜Œæ±Ÿé»æ—è‡ªæ²»å¿": { longitude: 109.0 },
                    "ä¹ä¸œé»æ—è‡ªæ²»å¿": { longitude: 109.1 },
                    "é™µæ°´é»æ—è‡ªæ²»å¿": { longitude: 110.0 },
                    "ä¿äº­é»æ—è‹—æ—è‡ªæ²»å¿": { longitude: 109.7 },
                    "ç¼ä¸­é»æ—è‹—æ—è‡ªæ²»å¿": { longitude: 109.8 }
                },
                "é‡åº†å¸‚": { "é‡åº†å¸‚": { longitude: 106.5 } },
                "å››å·çœ": {
                    "æˆéƒ½å¸‚": { longitude: 104.0 },
                    "è‡ªè´¡å¸‚": { longitude: 104.7 },
                    "æ”€æèŠ±å¸‚": { longitude: 101.7 },
                    "æ³¸å·å¸‚": { longitude: 105.4 },
                    "å¾·é˜³å¸‚": { longitude: 104.3 },
                    "ç»µé˜³å¸‚": { longitude: 104.7 },
                    "å¹¿å…ƒå¸‚": { longitude: 105.8 },
                    "é‚å®å¸‚": { longitude: 105.5 },
                    "å†…æ±Ÿå¸‚": { longitude: 105.0 },
                    "ä¹å±±å¸‚": { longitude: 103.7 },
                    "å—å……å¸‚": { longitude: 106.1 },
                    "çœ‰å±±å¸‚": { longitude: 103.8 },
                    "å®œå®¾å¸‚": { longitude: 104.5 },
                    "å¹¿å®‰å¸‚": { longitude: 106.6 },
                    "è¾¾å·å¸‚": { longitude: 107.5 },
                    "é›…å®‰å¸‚": { longitude: 103.0 },
                    "å·´ä¸­å¸‚": { longitude: 106.7 },
                    "èµ„é˜³å¸‚": { longitude: 104.9 },
                    "é˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·": { longitude: 102.2 },
                    "ç”˜å­œè—æ—è‡ªæ²»å·": { longitude: 101.9 },
                    "å‡‰å±±å½æ—è‡ªæ²»å·": { longitude: 102.2 }
                },
                "è´µå·çœ": {
                    "è´µé˜³å¸‚": { longitude: 106.7 },
                    "å…­ç›˜æ°´å¸‚": { longitude: 104.8 },
                    "éµä¹‰å¸‚": { longitude: 106.9 },
                    "å®‰é¡ºå¸‚": { longitude: 105.9 },
                    "æ¯•èŠ‚å¸‚": { longitude: 105.2 },
                    "é“œä»å¸‚": { longitude: 109.1 },
                    "é»”ä¸œå—è‹—æ—ä¾—æ—è‡ªæ²»å·": { longitude: 107.9 },
                    "é»”å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·": { longitude: 107.5 },
                    "é»”è¥¿å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·": { longitude: 104.9 }
                },
                "äº‘å—çœ": {
                    "æ˜†æ˜å¸‚": { longitude: 102.7 },
                    "æ›²é–å¸‚": { longitude: 103.8 },
                    "ç‰æºªå¸‚": { longitude: 102.5 },
                    "ä¿å±±å¸‚": { longitude: 99.1 },
                    "æ˜­é€šå¸‚": { longitude: 103.7 },
                    "ä¸½æ±Ÿå¸‚": { longitude: 100.2 },
                    "æ™®æ´±å¸‚": { longitude: 101.0 },
                    "ä¸´æ²§å¸‚": { longitude: 99.9 },
                    "æ¥šé›„å½æ—è‡ªæ²»å·": { longitude: 101.5 },
                    "çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·": { longitude: 103.4 },
                    "æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·": { longitude: 104.2 },
                    "è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·": { longitude: 100.8 },
                    "å¤§ç†ç™½æ—è‡ªæ²»å·": { longitude: 100.2 },
                    "å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·": { longitude: 98.6 },
                    "æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·": { longitude: 98.8 },
                    "è¿ªåº†è—æ—è‡ªæ²»å·": { longitude: 99.7 }
                },
                "è¥¿è—è‡ªæ²»åŒº": {
                    "æ‹‰è¨å¸‚": { longitude: 91.1 },
                    "æ—¥å–€åˆ™å¸‚": { longitude: 88.8 },
                    "æ˜Œéƒ½å¸‚": { longitude: 97.1 },
                    "æ—èŠå¸‚": { longitude: 94.3 },
                    "å±±å—å¸‚": { longitude: 91.7 },
                    "é‚£æ›²å¸‚": { longitude: 92.0 },
                    "é˜¿é‡Œåœ°åŒº": { longitude: 80.1 }
                },
                "é™•è¥¿çœ": {
                    "è¥¿å®‰å¸‚": { longitude: 108.9 },
                    "é“œå·å¸‚": { longitude: 109.1 },
                    "å®é¸¡å¸‚": { longitude: 107.1 },
                    "å’¸é˜³å¸‚": { longitude: 108.7 },
                    "æ¸­å—å¸‚": { longitude: 109.5 },
                    "å»¶å®‰å¸‚": { longitude: 109.4 },
                    "æ±‰ä¸­å¸‚": { longitude: 107.0 },
                    "æ¦†æ—å¸‚": { longitude: 109.7 },
                    "å®‰åº·å¸‚": { longitude: 109.0 },
                    "å•†æ´›å¸‚": { longitude: 110.0 }
                },
                "ç”˜è‚ƒçœ": {
                    "å…°å·å¸‚": { longitude: 103.7 },
                    "å˜‰å³ªå…³å¸‚": { longitude: 98.2 },
                    "é‡‘æ˜Œå¸‚": { longitude: 102.2 },
                    "ç™½é“¶å¸‚": { longitude: 104.1 },
                    "å¤©æ°´å¸‚": { longitude: 105.7 },
                    "æ­¦å¨å¸‚": { longitude: 102.6 },
                    "å¼ æ–å¸‚": { longitude: 100.4 },
                    "å¹³å‡‰å¸‚": { longitude: 106.6 },
                    "é…’æ³‰å¸‚": { longitude: 98.5 },
                    "åº†é˜³å¸‚": { longitude: 107.6 },
                    "å®šè¥¿å¸‚": { longitude: 104.6 },
                    "é™‡å—å¸‚": { longitude: 104.9 },
                    "ä¸´å¤å›æ—è‡ªæ²»å·": { longitude: 103.2 },
                    "ç”˜å—è—æ—è‡ªæ²»å·": { longitude: 102.9 }
                },
                "é’æµ·çœ": {
                    "è¥¿å®å¸‚": { longitude: 101.7 },
                    "æµ·ä¸œå¸‚": { longitude: 102.1 },
                    "æµ·åŒ—è—æ—è‡ªæ²»å·": { longitude: 100.9 },
                    "é»„å—è—æ—è‡ªæ²»å·": { longitude: 102.0 },
                    "æµ·å—è—æ—è‡ªæ²»å·": { longitude: 100.6 },
                    "æœæ´›è—æ—è‡ªæ²»å·": { longitude: 100.2 },
                    "ç‰æ ‘è—æ—è‡ªæ²»å·": { longitude: 97.0 },
                    "æµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·": { longitude: 97.0 }
                },
                "å®å¤å›æ—è‡ªæ²»åŒº": {
                    "é“¶å·å¸‚": { longitude: 106.2 },
                    "çŸ³å˜´å±±å¸‚": { longitude: 106.3 },
                    "å´å¿ å¸‚": { longitude: 106.1 },
                    "å›ºåŸå¸‚": { longitude: 106.2 },
                    "ä¸­å«å¸‚": { longitude: 105.1 }
                },
                "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº": {
                    "ä¹Œé²æœ¨é½å¸‚": { longitude: 87.6 },
                    "å…‹æ‹‰ç›ä¾å¸‚": { longitude: 84.7 },
                    "åé²ç•ªå¸‚": { longitude: 89.2 },
                    "å“ˆå¯†å¸‚": { longitude: 93.5 },
                    "æ˜Œå‰å›æ—è‡ªæ²»å·": { longitude: 87.3 },
                    "åšå°”å¡”æ‹‰è’™å¤è‡ªæ²»å·": { longitude: 82.0 },
                    "å·´éŸ³éƒ­æ¥è’™å¤è‡ªæ²»å·": { longitude: 86.1 },
                    "é˜¿å…‹è‹åœ°åŒº": { longitude: 80.3 },
                    "å…‹å­œå‹’è‹æŸ¯å°”å…‹å­œè‡ªæ²»å·": { longitude: 76.2 },
                    "å–€ä»€åœ°åŒº": { longitude: 75.9 },
                    "å’Œç”°åœ°åŒº": { longitude: 79.9 },
                    "ä¼ŠçŠå“ˆè¨å…‹è‡ªæ²»å·": { longitude: 81.3 },
                    "å¡”åŸåœ°åŒº": { longitude: 82.9 },
                    "é˜¿å‹’æ³°åœ°åŒº": { longitude: 88.1 },
                    "çŸ³æ²³å­å¸‚": { longitude: 86.0 },
                    "é˜¿æ‹‰å°”å¸‚": { longitude: 81.2 },
                    "å›¾æœ¨èˆ’å…‹å¸‚": { longitude: 79.0 },
                    "äº”å®¶æ¸ å¸‚": { longitude: 87.2 }
                },
                "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº": { "é¦™æ¸¯": { longitude: 114.1 } },
                "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº": { "æ¾³é—¨": { longitude: 113.5 } },
                "å°æ¹¾çœ": {
                    "å°åŒ—å¸‚": { longitude: 121.5 },
                    "é«˜é›„å¸‚": { longitude: 120.3 }
                }
            };

            // ======================
            // åˆå§‹åŒ–çœä»½åˆ—è¡¨
            // ======================
            function populateProvinces() {
                const provinceSelect = document.getElementById('birthProvince');
                provinceSelect.innerHTML = '<option value="">- è¯·é€‰æ‹©çœä»½ -</option>' + 
                    Object.keys(locationData).map(province => 
                        `<option value="${province}">${province}</option>`
                    ).join('');
            }

            // ======================
            // åˆå§‹åŒ–åŸå¸‚åˆ—è¡¨
            // ======================
            function populateCities(province) {
                const citySelect = document.getElementById('birthCity');
                const cities = locationData[province] || {};
                
                citySelect.innerHTML = '<option value="">- è¯·é€‰æ‹©åŸå¸‚ -</option>' + 
                    Object.keys(cities).map(city => 
                        `<option value="${city}">${city}</option>`
                    ).join('');
            }

            function validateForm() {
                errorMessage.style.display = 'none';
                errorMessage.textContent = '';
                let isValid = true;

                const birthDateValue = birthDateInput.value;
                const birthHourValue = birthHourInput.value;
                const birthMinuteValue = birthMinuteInput.value;

                if (!birthDateValue) {
                    errorMessage.textContent += "è¯·å¡«å†™å‡ºç”Ÿå¹´æœˆæ—¥ã€‚";
                    isValid = false;
                } else {
                    const dateParts = birthDateValue.split('-');
                    if (dateParts.length !== 3 || isNaN(parseInt(dateParts[0])) || isNaN(parseInt(dateParts[1])) || isNaN(parseInt(dateParts[2]))) {
                        errorMessage.textContent += "å‡ºç”Ÿå¹´æœˆæ—¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º YYYY-MM-DDã€‚";
                        isValid = false;
                    }
                }

                if (!birthHourValue) {
                    errorMessage.textContent += "è¯·é€‰æ‹©å‡ºç”Ÿå°æ—¶ã€‚";
                    isValid = false;
                }

                if (!birthMinuteValue) {
                    errorMessage.textContent += "è¯·é€‰æ‹©å‡ºç”Ÿåˆ†é’Ÿã€‚";
                    isValid = false;
                }

                if (!Array.from(genderRadios).some(radio => radio.checked)) {
                    errorMessage.textContent += "è¯·é€‰æ‹©æ€§åˆ«ã€‚";
                    isValid = false;
                }
                if (!provinceSelect.value) {
                    errorMessage.textContent += "è¯·é€‰æ‹©å‡ºç”Ÿçœä»½/ç›´è¾–å¸‚ã€‚"; // ä¿®æ”¹æç¤ºä¿¡æ¯
                    isValid = false;
                }
                if (!citySelect.value) {
                    errorMessage.textContent += "è¯·é€‰æ‹©å‡ºç”ŸåŸå¸‚ã€‚";
                    isValid = false;
                }

                if (!isValid) {
                    errorMessage.style.display = 'block';
                }
                return isValid;
            }

            function adjustDateTimeForLongitude(datetime, longitude) {
            // Adjust time based on longitude difference from Beijing (116.4Â°E)
            const beijingLongitude = 116.4;
            const timeDiffMinutes = Math.round((longitude - beijingLongitude) * 4); // 4 minutes per degree

            const adjustedTime = new Date(datetime.getTime() + timeDiffMinutes * 60 * 1000);
            return adjustedTime;
        }

        function calculateTenGod(dayStem, otherStem) {
            const tenGods = {
                "ç”²": {
                    "ç”²": "æ¯”è‚©", "ä¹™": "åŠ«è´¢", "ä¸™": "é£Ÿç¥", "ä¸": "ä¼¤å®˜",
                    "æˆŠ": "åè´¢", "å·±": "æ­£è´¢", "åºš": "ä¸ƒæ€", "è¾›": "æ­£å®˜",
                    "å£¬": "åå°", "ç™¸": "æ­£å°"
                },
                "ä¹™": {
                    "ç”²": "åŠ«è´¢", "ä¹™": "æ¯”è‚©", "ä¸™": "ä¼¤å®˜", "ä¸": "é£Ÿç¥",
                    "æˆŠ": "æ­£è´¢", "å·±": "åè´¢", "åºš": "æ­£å®˜", "è¾›": "ä¸ƒæ€",
                    "å£¬": "æ­£å°", "ç™¸": "åå°"
                },
                "ä¸™": {
                    "ç”²": "åå°", "ä¹™": "æ­£å°", "ä¸™": "æ¯”è‚©", "ä¸": "åŠ«è´¢",
                    "æˆŠ": "é£Ÿç¥", "å·±": "ä¼¤å®˜", "åºš": "åè´¢", "è¾›": "æ­£è´¢",
                    "å£¬": "ä¸ƒæ€", "ç™¸": "æ­£å®˜"
                },
                "ä¸": {
                    "ç”²": "æ­£å°", "ä¹™": "åå°", "ä¸™": "åŠ«è´¢", "ä¸": "æ¯”è‚©",
                    "æˆŠ": "ä¼¤å®˜", "å·±": "é£Ÿç¥", "åºš": "æ­£è´¢", "è¾›": "åè´¢",
                    "å£¬": "æ­£å®˜", "ç™¸": "ä¸ƒæ€"
                },
                "æˆŠ": {
                    "ç”²": "ä¸ƒæ€", "ä¹™": "æ­£å®˜", "ä¸™": "åå°", "ä¸": "æ­£å°",
                    "æˆŠ": "æ¯”è‚©", "å·±": "åŠ«è´¢", "åºš": "é£Ÿç¥", "è¾›": "ä¼¤å®˜",
                    "å£¬": "åè´¢", "ç™¸": "æ­£è´¢"
                },
                "å·±": {
                    "ç”²": "æ­£å®˜", "ä¹™": "ä¸ƒæ€", "ä¸™": "æ­£å°", "ä¸": "åå°",
                    "æˆŠ": "åŠ«è´¢", "å·±": "æ¯”è‚©", "åºš": "ä¼¤å®˜", "è¾›": "é£Ÿç¥",
                    "å£¬": "æ­£è´¢", "ç™¸": "åè´¢"
                },
                "åºš": {
                    "ç”²": "åè´¢", "ä¹™": "æ­£è´¢", "ä¸™": "ä¸ƒæ€", "ä¸": "æ­£å®˜",
                    "æˆŠ": "åå°", "å·±": "æ­£å°", "åºš": "æ¯”è‚©", "è¾›": "åŠ«è´¢",
                    "å£¬": "é£Ÿç¥", "ç™¸": "ä¼¤å®˜"
                },
                "è¾›": {
                    "ç”²": "æ­£è´¢", "ä¹™": "åè´¢", "ä¸™": "æ­£å®˜", "ä¸": "ä¸ƒæ€",
                    "æˆŠ": "æ­£å°", "å·±": "åå°", "åºš": "åŠ«è´¢", "è¾›": "æ¯”è‚©",
                    "å£¬": "ä¼¤å®˜", "ç™¸": "é£Ÿç¥"
                },
                "å£¬": {
                    "ç”²": "é£Ÿç¥", "ä¹™": "ä¼¤å®˜", "ä¸™": "åè´¢", "ä¸": "æ­£è´¢",
                    "æˆŠ": "ä¸ƒæ€", "å·±": "æ­£å®˜", "åºš": "åå°", "è¾›": "æ­£å°",
                    "å£¬": "æ¯”è‚©", "ç™¸": "åŠ«è´¢"
                },
                "ç™¸": {
                    "ç”²": "ä¼¤å®˜", "ä¹™": "é£Ÿç¥", "ä¸™": "æ­£è´¢", "ä¸": "åè´¢",
                    "æˆŠ": "æ­£å®˜", "å·±": "ä¸ƒæ€", "åºš": "æ­£å°", "è¾›": "åå°",
                    "å£¬": "åŠ«è´¢", "ç™¸": "æ¯”è‚©"
                }
            };

            return tenGods[dayStem][otherStem];
        }

        function calculateDayun(birthDate, gender, yearStem) {
            // Simple calculation for the demonstration
            // In a real application, this would be more complex using lunisolar's fate calculation
            const isMale = gender === 'ç”·';
            const stems = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"];
            const branches = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];

            // Get index of year stem
            const stemIndex = stems.indexOf(yearStem);

            // Determine direction based on gender and stem
            const forward = (isMale && stemIndex % 2 === 0) || (!isMale && stemIndex % 2 === 1);

            // Start year is typically around age 10
            const startYear = birthDate.getFullYear() + 10;

            // Generate dayun sequence
            const dayun = [];
            let currentStemIndex = stemIndex;
            let currentBranchIndex = branches.indexOf("å¯…"); // Example starting branch

            for (let i = 0; i < 8; i++) {
                const direction = forward ? 1 : -1;
                currentStemIndex = (currentStemIndex + direction + 10) % 10;
                currentBranchIndex = (currentBranchIndex + direction + 12) % 12;
                dayun.push(stems[currentStemIndex] + branches[currentBranchIndex]);
            }

            return {
                startYear: startYear,
                dayun: dayun
            };
        }

        function generateBaziPrompt(char8, gender, birthProvince, birthCity, bigLuck, birthYear) {
            const yearPillar = char8.year.toString();
            const monthPillar = char8.month.toString();
            const dayPillar = char8.day.toString();
            const hourPillar = char8.hour.toString();

            const dayStem = dayPillar[0];
            const yearTenGod = calculateTenGod(dayStem, yearPillar[0]);
            const monthTenGod = calculateTenGod(dayStem, monthPillar[0]);
            const hourTenGod = calculateTenGod(dayStem, hourPillar[0]);

            let prompt = "";
            prompt += `ä½ æ˜¯ä¸€ä½å¯¹ä¸­å›½ä¼ ç»Ÿå…«å­—å‘½ç†å­¦æœ‰ç€æ·±åˆ»ç†è§£å’Œä¸°å¯Œç»éªŒçš„ä¸“å®¶ã€‚ä½ ç²¾é€šã€Šæ»´å¤©é«“ã€‹ã€ã€Šå­å¹³çœŸè¯ ã€‹ã€ã€Šç©·é€šå®é‰´ã€‹ç­‰ç»å…¸è‘—ä½œï¼Œæ“…é•¿è¿ç”¨äº”è¡Œç”Ÿå…‹ã€åç¥æ„è±¡ã€æ ¼å±€å–œå¿Œç­‰ç†è®ºï¼Œå¯¹äººç”Ÿå‘½è¿è¿›è¡Œåˆ†æå’Œè§£è¯»ã€‚\n\n`;
            prompt += `ç°åœ¨ä½ å°†é¢å¯¹ä¸€ä¸ªå…«å­—å‘½ä¾‹ï¼Œè¯·ä½ è¿ç”¨ä½ çš„ä¸“ä¸šçŸ¥è¯†å’Œç»éªŒï¼Œå¯¹è¯¥å‘½ä¾‹è¿›è¡Œå…¨é¢ã€æ·±å…¥çš„åˆ†æï¼Œå¹¶ç»™å‡ºæœ‰ä»·å€¼çš„å»ºè®®ã€‚è¯·ä½ åŠ¡å¿…é€æ­¥æ€è€ƒã€æ¨ç†ï¼Œå¹¶æ¸…æ™°åœ°å±•ç¤ºä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚\n\n`;

            prompt += `æ±‚æµ‹è€…çš„åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š\n`;
            prompt += `æ€§åˆ«ï¼š${gender}\n`;
            prompt += `å‡ºç”Ÿåœ°åŒºï¼š${birthProvince} ${birthCity}\n`;
            prompt += `å‡ºç”Ÿå¹´ä»½ï¼š${birthYear}å¹´\n\n`;

            prompt += `å…¶å…«å­—å‘½ç›˜å¦‚ä¸‹ï¼š\n`;
            // å››æŸ±
            prompt += `å¹´æŸ±ï¼š${yearPillar}ï¼ˆ${yearTenGod}ï¼‰\n`;
            prompt += `æœˆæŸ±ï¼š${monthPillar}ï¼ˆ${monthTenGod}ï¼‰\n`;
            prompt += `æ—¥æŸ±ï¼š${dayPillar}ï¼ˆæ—¥å…ƒï¼‰\n`;
            prompt += `æ—¶æŸ±ï¼š${hourPillar}ï¼ˆ${hourTenGod}ï¼‰\n\n`;

            prompt += `å¤§è¿ä¿¡æ¯ï¼šä»${bigLuck.startYear}å¹´èµ·è¿ï¼Œè¿ç¨‹é¡ºåºä¸ºï¼š${bigLuck.dayun.join('ã€')}\n\n`;

            prompt += `è¯·ä½ ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼Œå±•å¼€ä½ çš„åˆ†æï¼š\n\n`;

            prompt += `1.æ•´ä½“å®¡è§†å‘½å±€ï¼šé¦–å…ˆï¼Œè¯·ä½ å¯¹å‘½ä¸»è¿›è¡Œå…«å­—æ’ç›˜ï¼Œä»äº”è¡Œã€é˜´é˜³ã€åç¥ã€æ ¼å±€ç­‰å¤šä¸ªè§’åº¦å…¥æ‰‹ï¼Œå¯¹å‘½å±€çš„æ•´ä½“ç‰¹ç‚¹è¿›è¡Œæ¦‚æ‹¬æ€§çš„æè¿°ã€‚ä¾‹å¦‚ï¼Œäº”è¡Œæ˜¯å¦å‡è¡¡ï¼Ÿé˜´é˜³æ˜¯å¦åè°ƒï¼Ÿæ˜¯å¦å­˜åœ¨æŸç§ç‰¹æ®Šçš„æ ¼å±€ï¼Ÿæ—¥å…ƒå¾—ä»¤ã€å¾—åœ°ã€å¾—åŠ©å—ï¼Ÿ\n\n`;

            prompt += `2.åˆ†ææ—¥å…ƒå¼ºå¼±ï¼šæ—¥å…ƒä»£è¡¨å‘½ä¸»è‡ªèº«ï¼Œå…¶å¼ºå¼±ç›´æ¥å…³ç³»åˆ°å‘½ä¸»çš„è¿åŠ¿ã€‚è¯·ä½ ç»“åˆæœˆä»¤ã€åœ°æ”¯ã€å¤©å¹²ç­‰å› ç´ ï¼Œç»¼åˆåˆ¤æ–­æ—¥å…ƒçš„å¼ºå¼±ï¼Œå¹¶è¯´æ˜åˆ¤æ–­çš„ä¾æ®ã€‚å¦‚æœæ—¥å…ƒåå¼ºï¼Œå–œä»€ä¹ˆï¼Ÿå¿Œä»€ä¹ˆï¼Ÿå¦‚æœæ—¥å…ƒåå¼±ï¼Œåˆè¯¥å¦‚ä½•å–ç”¨ç¥ï¼Ÿ\n\n`;

            prompt += `3.å‰–ææ€§æ ¼ç‰¹å¾ï¼šæ€§æ ¼å†³å®šå‘½è¿ã€‚è¯·ä½ ç»“åˆå…«å­—å‘½ç›˜ï¼Œåˆ†æå‘½ä¸»çš„æ€§æ ¼ç‰¹ç‚¹ã€ä¼˜ç¼ºç‚¹ï¼Œä»¥åŠå¯èƒ½çš„å‘å±•æ–¹å‘ã€‚ä¾‹å¦‚ï¼Œæ˜¯ç§¯æè¿›å–è¿˜æ˜¯ä¿å®ˆç¨³é‡ï¼Ÿæ˜¯å–„äºäº¤é™…è¿˜æ˜¯å–œæ¬¢ç‹¬å¤„ï¼Ÿæ˜¯ç†æ€§æ€ç»´è¿˜æ˜¯æ„Ÿæ€§æ€ç»´ï¼Ÿè¿™äº›æ€§æ ¼ç‰¹ç‚¹å¯¹å‘½ä¸»çš„äººç”Ÿæœ‰ä½•å½±å“ï¼Ÿ\n\n`;

            prompt += `4.æ¨æ–­äº‹ä¸šå‘å±•ï¼šäº‹ä¸šæ˜¯äººç”Ÿä»·å€¼çš„é‡è¦ä½“ç°ã€‚è¯·ä½ ç»“åˆå…«å­—å‘½ç›˜ï¼Œåˆ†æå‘½ä¸»çš„äº‹ä¸šè¿åŠ¿ã€é€‚åˆçš„èŒä¸šã€å‘å±•æ–¹å‘ç­‰ã€‚ä¾‹å¦‚ï¼Œé€‚åˆä»äº‹ç¨³å®šçš„å·¥ä½œè¿˜æ˜¯å…·æœ‰æŒ‘æˆ˜æ€§çš„å·¥ä½œï¼Ÿé€‚åˆè‡ªå·±åˆ›ä¸šè¿˜æ˜¯åœ¨ä¼ä¸šä¸­å‘å±•ï¼Ÿåœ¨äº‹ä¸šå‘å±•è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„å“ªäº›é—®é¢˜ï¼Ÿ\n\n`;

            prompt += `5.é¢„æµ‹è´¢å¯Œè¿åŠ¿ï¼šè´¢å¯Œæ˜¯äººç”Ÿå¹¸ç¦çš„é‡è¦ä¿éšœã€‚è¯·ä½ ç»“åˆå…«å­—å‘½ç›˜ï¼Œåˆ†æå‘½ä¸»çš„è´¢å¯ŒçŠ¶å†µã€è´¢è¿èµ°åŠ¿ã€ç†è´¢å»ºè®®ç­‰ã€‚ä¾‹å¦‚ï¼Œæ˜¯æ­£è´¢è¿æ—ºç››è¿˜æ˜¯åè´¢è¿æ—ºç››ï¼Ÿé€‚åˆä»äº‹å“ªäº›è¡Œä¸šçš„æŠ•èµ„ï¼Ÿåœ¨ç†è´¢æ–¹é¢éœ€è¦æ³¨æ„å“ªäº›é—®é¢˜ï¼Ÿ\n\n`;

            prompt += `6.ç ”åˆ¤å©šå§»æƒ…æ„Ÿï¼šå©šå§»æ˜¯äººç”Ÿé‡è¦çš„ç»„æˆéƒ¨åˆ†ã€‚è¯·ä½ ç»“åˆå…«å­—å‘½ç›˜ï¼Œåˆ†æå‘½ä¸»çš„å©šå§»è¿åŠ¿ã€æƒ…æ„ŸçŠ¶å†µã€å©šæ‹å»ºè®®ç­‰ã€‚ä¾‹å¦‚ï¼Œæ˜¯æ—©å©šå¥½è¿˜æ˜¯æ™šå©šå¥½ï¼Ÿé€‚åˆæ‰¾ä»€ä¹ˆæ ·çš„ä¼´ä¾£ï¼Ÿåœ¨å©šå§»ä¸­éœ€è¦æ³¨æ„å“ªäº›é—®é¢˜ï¼Ÿ\n\n`;

            prompt += `7.å…³æ³¨å¥åº·çŠ¶å†µï¼šå¥åº·æ˜¯å¹¸ç¦äººç”Ÿçš„åŸºçŸ³ã€‚è¯·ä½ ç»“åˆå…«å­—å‘½ç›˜ï¼Œåˆ†æå‘½ä¸»çš„å¥åº·çŠ¶å†µã€å¯èƒ½å­˜åœ¨çš„å¥åº·éšæ‚£ã€å…»ç”Ÿå»ºè®®ç­‰ã€‚ä¾‹å¦‚ï¼Œäº”è¡Œå¤±è¡¡å¯èƒ½å¯¼è‡´å“ªäº›ç–¾ç—…ï¼Ÿéœ€è¦æ³¨æ„å“ªäº›æ–¹é¢çš„ä¿å¥ï¼Ÿ\n\n`;

            prompt += `8.æ´å¯Ÿå…­äº²å…³ç³»ï¼šå…­äº²æ˜¯ä¸å‘½ä¸»å…³ç³»æœ€ä¸ºå¯†åˆ‡çš„äººã€‚è¯·ä½ ç»“åˆå…«å­—å‘½ç›˜ï¼Œåˆ†æå‘½ä¸»ä¸çˆ¶æ¯ã€é…å¶ã€å­å¥³ç­‰å…­äº²çš„å…³ç³»ï¼Œä»¥åŠå…­äº²å¯¹å‘½ä¸»çš„å½±å“ã€‚ä¾‹å¦‚ï¼Œä¸çˆ¶æ¯çš„å…³ç³»å¦‚ä½•ï¼Ÿé…å¶å¯¹è‡ªå·±æœ‰å¸®åŠ©å—ï¼Ÿå­å¥³æ˜¯å¦å­é¡ºï¼Ÿ\n\n`;

            prompt += `9.æŠŠæ¡å¤§è¿æµå¹´ï¼šå¤§è¿å’Œæµå¹´æ˜¯å½±å“å‘½ä¸»è¿åŠ¿çš„é‡è¦å› ç´ ã€‚è¯·ä½ ç»“åˆå¤§è¿å’Œæµå¹´ï¼Œåˆ†æå‘½ä¸»åœ¨ä¸åŒäººç”Ÿé˜¶æ®µçš„è¿åŠ¿å˜åŒ–ï¼Œä¸ºå‘½ä¸»æä¾›äººç”Ÿè§„åˆ’å»ºè®®ã€‚ä¾‹å¦‚ï¼Œå“ªäº›å¹´ä»½æ˜¯æœºé‡æœŸï¼Ÿå“ªäº›å¹´ä»½æ˜¯æŒ‘æˆ˜æœŸï¼Ÿåº”è¯¥å¦‚ä½•æŠŠæ¡æœºé‡ã€åº”å¯¹æŒ‘æˆ˜ï¼Ÿ\n\n`;

            prompt += `åœ¨åˆ†æè¿‡ç¨‹ä¸­ï¼Œè¯·ä½ å……åˆ†å‘æŒ¥ä½ çš„èªæ˜æ‰æ™ºï¼Œè¿ç”¨ä½ æ‰€æŒæ¡çš„å‘½ç†å­¦çŸ¥è¯†ï¼Œç»“åˆå®é™…æƒ…å†µï¼Œå¯¹å‘½ä¾‹è¿›è¡Œæ·±å…¥çš„å‰–æå’Œè§£è¯»ï¼Œå¹¶ç»™å‡ºæœ‰ä»·å€¼çš„å»ºè®®ã€‚\n\n`;
            prompt += `è¯·è®°ä½ï¼Œä½ çš„ç›®æ ‡æ˜¯å¸®åŠ©æ±‚æµ‹è€…æ›´å¥½åœ°äº†è§£è‡ªå·±ï¼ŒæŠŠæ¡å‘½è¿ï¼Œåˆ›é€ å¹¸ç¦çš„äººç”Ÿã€‚\n\n`;
            prompt += `è¯·å¼€å§‹ä½ çš„åˆ†æå§ï¼`;

            return prompt;
        }

            // åˆå¹¶åçš„å”¯ä¸€æŒ‰é’®äº‹ä»¶
            generateBtn.addEventListener('click', async function() {
                if (!validateForm() || typeof lunisolar === 'undefined') return;

                // æ˜¾ç¤ºå¤„ç†çŠ¶æ€
                const processingBox = document.getElementById('processing-box');
                const stepsDiv = document.getElementById('processing-steps');
                processingBox.style.display = 'block';
                stepsDiv.innerHTML = '';
                processingMessageDiv.textContent = 'æ­£åœ¨åˆå§‹åŒ–å‘½ç†å‚æ•°...';

                try {
                     // åˆå§‹åŒ–çŠ¶æ€
                    processingBox.style.display = 'block';
                    stepsDiv.innerHTML = '';
                    llmOutputDiv.textContent = '';
                    apiErrorMessage.style.display = 'none';
                    
                    // éªŒè¯è¾“å…¥
                    if (!validateForm()) throw new Error('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                    processingMessageDiv.textContent = 'æ­£åœ¨åˆå§‹åŒ–å‘½ç†å‚æ•°...';
                    
                                        
                    // ç”Ÿæˆpromptï¼ˆåŸé€»è¾‘ï¼‰
                    const birthDateValue = birthDateInput.value;
                    const hourValue = birthHourInput.value;
                    const minuteValue = birthMinuteInput.value;
                    const birthDateTimeStr = `${birthDateValue} ${hourValue}:${minuteValue}`;
                    const gender = document.querySelector('input[name="gender"]:checked').value;
                    const birthProvince = provinceSelect.value;
                    const birthCity = citySelect.value;
                    const longitude = locationData[birthProvince][birthCity].longitude;

                    // æ—¶é—´è°ƒæ•´è®¡ç®—...
                    const birthDateTime = new Date(birthDateValue);
                    birthDateTime.setHours(parseInt(hourValue));
                    birthDateTime.setMinutes(parseInt(minuteValue));
                    const adjustedDateTime = adjustDateTimeForLongitude(birthDateTime, longitude);
                    const adjustedDateStr = adjustedDateTime.toISOString().slice(0, 16).replace('T', ' ');

                    // ç”Ÿæˆå…«å­—ä¿¡æ¯
                    const lsr = lunisolar(birthDateTimeStr);
                    const char8 = lsr.char8;
                    const genderCode = gender === 'ç”·' ? 1 : 0;
                    const bigLuck = calculateDayun(birthDateTime, gender, char8.year.stem.toString());
                    const prompt = generateBaziPrompt(char8, gender, birthProvince, birthCity, bigLuck, birthDateTime.getFullYear());

                    // æ˜¾ç¤ºå¤„ç†è¿›åº¦
                    const steps = [
                        "æ­£åœ¨è¿æ¥é‡å­æœåŠ¡å™¨...",
                        "åˆå§‹åŒ–ç¥ç»ç½‘ç»œ...",
                        "åŠ è½½å‘½ç†æ•°æ®åº“...",
                        "è§£ææ—¶ç©ºåæ ‡...",
                        "æ„å»ºäº”è¡Œæ¨¡å‹...",
                        "è¿›è¡Œé‡å­æ¨æ¼”...",
                        "ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š..."
                    ];
                    let currentStep = 0;
                    const stepInterval = setInterval(() => {
                        if (currentStep < steps.length) {
                            stepsDiv.innerHTML += `ğ“€« ${steps[currentStep]}<br>`;
                            processingMessageDiv.textContent = `è¿›åº¦: ${Math.round((currentStep+1)/steps.length*100)}%`;
                            currentStep++;
                        } else {
                            clearInterval(stepInterval);
                        }
                    }, 800);

                    const apiKey = llmApiKeyInput.value.trim();
                    if (!apiKey) {
                        throw new Error('éœ€è¦APIå¯†é’¥å¯åŠ¨é‡å­æ¼”ç®—');
                    }
                    const modelName = document.getElementById('llmModel').value || 'deepseek-r1';
                    
                    // æ‰§è¡ŒAPIè°ƒç”¨
                    await callLLMAPI(prompt, apiKey, modelName);
                    
                } catch (error) {
                    // ======================
                    // é”™è¯¯å¤„ç†
                    // ======================
                    apiErrorMessage.textContent = `ğ“ƒ£ ç³»ç»Ÿé”™è¯¯: ${error.message}`;
                    apiErrorMessage.style.display = 'block';
                    console.error('Error:', error);
                    
                } finally {
                    // ======================
                    // æ¸…ç†é˜¶æ®µ
                    // ======================
                    clearInterval(stepInterval);
                    processingBox.style.display = 'none';
                }
            });


        

            async function callLLMAPI(prompt, apiKey, modelName) {
                try {
                    const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: modelName,
                            messages: [
                                {
                                    role: "system",
                                    content: "ä½ æ˜¯ç²¾é€šä¸­å›½å…«å­—å‘½ç†å­¦çš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿç”¨ä¸“ä¸šæœ¯è¯­è¿›è¡Œè¯¦ç»†åˆ†æ"
                                },
                                { role: "user", content: prompt }
                            ],
                            stream: true
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`APIé”™è¯¯ (${response.status}): ${errorData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }

                    // ======================
                    // æµå¼æ•°æ®å¤„ç†å¢å¼ºç‰ˆ
                    // ======================
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        
                        // å¤„ç†å¤šè¡Œæ•°æ®
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // ä¿ç•™æœªå®Œæˆéƒ¨åˆ†
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    const content = data.choices[0]?.delta?.content || '';
                                    llmOutputDiv.textContent += content;
                                } catch (e) {
                                    console.warn('è§£ææ•°æ®å¤±è´¥:', e);
                                }
                            }
                        }
                    }
                    
                } catch (error) {
                    throw new Error(`APIé€šä¿¡å¤±è´¥: ${error.message}`);
                }
            }
    // Wait for lunisolar to load
    script.onload = function() {
            console.log("Lunisolaråº“å·²åŠ è½½");
        };

        // ======================
        // äº‹ä»¶ç›‘å¬å™¨
        // ======================
        document.getElementById('birthProvince').addEventListener('change', function() {
            populateCities(this.value);
        });

        // ======================
        // åˆå§‹åŒ–æ‰§è¡Œ
        // ======================
        populateProvinces();
    });
    
    
    
    </script>
</body>
</html>